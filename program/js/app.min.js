function rcube_webmail(){this.labels={},this.buttons={},this.buttons_sel={},this.gui_objects={},this.gui_containers={},this.commands={},this.command_handlers={},this.onloads=[],this.messages={},this.group2expand={},this.http_request_jobs={},this.menu_stack=[],this.dblclick_time=500,this.message_time=5e3,this.identifier_expr=/[^0-9a-z_-]/gi,this.env={request_timeout:180,draft_autosave:0,comm_path:"./",recipients_separator:",",recipients_delimiter:", ",popup_width:1150,popup_width_small:900},this.ref="rcmail";var ref=this;$.ajaxSetup({cache:!1,timeout:1e3*this.env.request_timeout,error:function(a,b,c){ref.http_error(a,b,c)},beforeSend:function(a){a.setRequestHeader("X-Roundcube-Request",ref.env.request_token)}}),$(window).on("beforeunload",function(){ref.unload=!0}),this.set_env=function(a,b){if(null==a||"object"!=typeof a||b)this.env[a]=b;else for(var c in a)this.env[c]=a[c]},this.add_label=function(a,b){"string"==typeof a?this.labels[a]=b:"object"==typeof a&&$.extend(this.labels,a)},this.register_button=function(a,b,c,d,e,f){var g={id:b,type:c};d&&(g.act=d),e&&(g.sel=e),f&&(g.over=f),this.buttons[a]||(this.buttons[a]=[]),this.buttons[a].push(g),this.loaded&&init_button(a,g)},this.gui_object=function(a,b){this.gui_objects[a]=this.loaded?rcube_find_object(b):b},this.gui_container=function(a,b){this.gui_containers[a]=b},this.add_element=function(a,b){this.gui_containers[b]&&this.gui_containers[b].jquery&&this.gui_containers[b].append(a)},this.register_command=function(a,b,c){this.command_handlers[a]=b,c&&this.enable_command(a,!0)},this.add_onload=function(a){this.onloads.push(a)},this.init=function(){var n;if(this.task=this.env.task,!(409==this.env.server_error||bw.dom&&bw.xmlhttp_test()))return void this.goto_url("error","_code=0x199");this.env.blankpage||(this.env.blankpage=this.assets_path("program/resources/blank.gif"));for(n in this.gui_containers)this.gui_containers[n]=$("#"+this.gui_containers[n]);for(n in this.gui_objects)this.gui_objects[n]=rcube_find_object(this.gui_objects[n]);if(this.env.x_frame_options)try{if("deny"==this.env.x_frame_options&&top.location.href!=self.location.href)top.location.href=self.location.href;else if(top.location.hostname!=self.location.hostname)throw 1}catch(a){return $("form").each(function(){ref.lock_form(this,!0)}),void this.display_message("Blocked: possible clickjacking attack!","error")}switch(this.init_buttons(),this.is_framed()&&(parent.rcmail.set_busy(!1,null,parent.rcmail.env.frame_lock),parent.rcmail.env.frame_lock=null),this.enable_command("close","logout","mail","addressbook","settings","save-pref","compose","undo","about","switch-task","menu-open","menu-close","menu-save",!0),this.set_button(this.task,"sel"),this.env.permaurl&&this.enable_command("permaurl","extwin",!0),this.task){case"mail":if(this.enable_command("list","checkmail","add-contact","search","reset-search","collapse-folder","import-messages",!0),this.gui_objects.messagelist&&(this.message_list=new rcube_list_widget(this.gui_objects.messagelist,{multiselect:!0,multiexpand:!0,draggable:!0,keyboard:!0,column_movable:this.env.col_movable,dblclick_time:this.dblclick_time}),this.message_list.addEventListener("initrow",function(a){ref.init_message_row(a)}).addEventListener("dblclick",function(a){ref.msglist_dbl_click(a)}).addEventListener("click",function(a){ref.msglist_click(a)}).addEventListener("keypress",function(a){ref.msglist_keypress(a)}).addEventListener("select",function(a){ref.msglist_select(a)}).addEventListener("dragstart",function(a){ref.drag_start(a)}).addEventListener("dragmove",function(a){ref.drag_move(a)}).addEventListener("dragend",function(a){ref.drag_end(a)}).addEventListener("expandcollapse",function(a){ref.msglist_expand(a)}).addEventListener("column_replace",function(a){ref.msglist_set_coltypes(a)}).addEventListener("listupdate",function(a){ref.triggerEvent("listupdate",a)}).init(),$(this.message_list.thead).on("click","a.sortcol",function(a){return ref.command("sort",$(this).attr("rel"),this)}),this.enable_command("toggle_status","toggle_flag","sort",!0),this.enable_command("set-listmode",this.env.threads&&!this.is_multifolder_listing()),this.command("list"),$(this.gui_objects.qsearchbox).val(this.env.search_text).focusin(function(){ref.message_list.blur()})),this.set_button_titles(),this.env.message_commands=["show","reply","reply-all","reply-list","move","copy","delete","open","mark","edit","viewsource","print","load-attachment","download-attachment","show-headers","hide-headers","download","forward","forward-inline","forward-attachment","change-format"],"show"==this.env.action||"preview"==this.env.action?(this.enable_command(this.env.message_commands,this.env.uid),this.enable_command("reply-list",this.env.list_post),"show"==this.env.action&&this.http_request("pagenav",{_uid:this.env.uid,_mbox:this.env.mailbox,_search:this.env.search_request},this.display_message("","loading")),this.env.blockedobjects&&(this.gui_objects.remoteobjectsmsg&&(this.gui_objects.remoteobjectsmsg.style.display="block"),this.enable_command("load-images","always-load",!0)),"preview"==this.env.action&&this.is_framed()&&(this.enable_command("compose","add-contact",!1),parent.rcmail.show_contentframe(!0)),this.gui_objects.attachments&&$("li > a",this.gui_objects.attachments).not(".drop").on("dragstart",function(a){var b,c=this.href,d=a.originalEvent.dataTransfer;d&&(c=c.replace(/^https?:\/\//,function(a){return a+urlencode(ref.env.username)+"@"}),b=$(this).clone(),b.children().remove(),d.setData("roundcube-uri",c),d.setData("roundcube-name",$.trim(b.text())))})):"compose"==this.env.action?(this.env.address_group_stack=[],this.env.compose_commands=["send-attachment","remove-attachment","send","cancel","toggle-editor","list-addresses","pushgroup","search","reset-search","extwin","insert-response","save-response","menu-open","menu-close"],this.env.drafts_mailbox&&this.env.compose_commands.push("savedraft"),this.enable_command(this.env.compose_commands,"identities","responses",!0),$.merge(this.env.compose_commands,["add-recipient","firstpage","previouspage","nextpage","lastpage"]),window.googie&&(this.env.editor_config.spellchecker=googie,this.env.editor_config.spellcheck_observer=function(a){ref.spellcheck_state()},this.env.compose_commands.push("spellcheck"),this.enable_command("spellcheck",!0)),this.editor_init(this.env.editor_config,this.env.composebody),this.gui_objects.responseslist&&($("a.insertresponse",this.gui_objects.responseslist).attr("unselectable","on").mousedown(function(a){return rcube_event.cancel(a)}).on("mouseup keypress",function(a){if("mouseup"==a.type||13==rcube_event.get_keycode(a))return ref.command("insert-response",$(this).attr("rel")),$(document.body).trigger("mouseup"),rcube_event.cancel(a)}),$.each(this.buttons["save-response"]||[],function(a,b){$("#"+b.id).mousedown(function(a){return rcube_event.cancel(a)})})),this.init_messageform()):"get"==this.env.action?(this.enable_command("download",!0),bw.mz&&"application/pdf"==this.env.mimetype?(n=0,$(this.gui_objects.messagepartframe).on("load",function(){if(n++)try{this.contentWindow.document,ref.enable_command("print",!0)}catch(a){}})):this.enable_command("print",!0)):"print"!=this.env.action||!this.env.uid||this.env.is_pgp_content||this.env.pgp_mime_part||this.print_dialog(),this.gui_objects.mailboxlist&&(this.env.unread_counts={},this.gui_objects.folderlist=this.gui_objects.mailboxlist,this.http_request("getunread",{_page:this.env.current_page})),this.gui_objects.contactslist&&(this.contact_list=new rcube_list_widget(this.gui_objects.contactslist,{multiselect:!0,draggable:!1,keyboard:!0}),this.contact_list.addEventListener("initrow",function(a){ref.triggerEvent("insertrow",{cid:a.uid,row:a})}).addEventListener("select",function(a){ref.compose_recipient_select(a)}).addEventListener("dblclick",function(a){ref.compose_add_recipient()}).addEventListener("keypress",function(a){a.key_pressed==a.ENTER_KEY&&(ref.compose_add_recipient()||a.last_selected&&"G"==String(a.last_selected).charAt(0)&&$(a.rows[a.last_selected].obj).find("a").first().click())}).init(),$("#_to,#_cc,#_bcc").focus(function(){ref.env.focused_field=this})),this.gui_objects.addressbookslist&&(this.gui_objects.folderlist=this.gui_objects.addressbookslist,this.enable_command("list-addresses",!0)),this.env.mdn_request&&this.env.uid){var postact="sendmdn",postdata={_uid:this.env.uid,_mbox:this.env.mailbox};confirm(this.get_label("mdnrequest"))||(postdata._flag="mdnsent",postact="mark"),this.http_post(postact,postdata)}this.check_mailvelope(this.env.action),this.is_framed()||this.env.extwin||this.browser_capabilities_check();break;case"addressbook":this.env.address_group_stack=[],this.gui_objects.folderlist&&(this.env.contactfolders=$.extend($.extend({},this.env.address_sources),this.env.contactgroups)),this.enable_command("add","import",this.env.writable_source),this.enable_command("list","listgroup","pushgroup","popgroup","listsearch","search","reset-search","advanced-search",!0),this.gui_objects.contactslist&&(this.contact_list=new rcube_list_widget(this.gui_objects.contactslist,{multiselect:!0,draggable:!!this.gui_objects.folderlist,keyboard:!0}),this.contact_list.addEventListener("initrow",function(a){ref.triggerEvent("insertrow",{cid:a.uid,row:a})}).addEventListener("keypress",function(a){ref.contactlist_keypress(a)}).addEventListener("select",function(a){ref.contactlist_select(a)}).addEventListener("dragstart",function(a){ref.drag_start(a)}).addEventListener("dragmove",function(a){ref.drag_move(a)}).addEventListener("dragend",function(a){ref.drag_end(a)}).init(),$(this.gui_objects.qsearchbox).focusin(function(){ref.contact_list.blur()}),this.update_group_commands(),this.command("list")),this.gui_objects.savedsearchlist&&(this.savedsearchlist=new rcube_treelist_widget(this.gui_objects.savedsearchlist,{id_prefix:"rcmli",id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode}),this.savedsearchlist.addEventListener("select",function(a){ref.triggerEvent("selectfolder",{folder:a.id,prefix:"rcmli"})})),this.set_page_buttons(),this.env.cid&&(this.enable_command("show","edit",!0),this.gui_objects.editform&&$("input.groupmember").change(function(){ref.group_member_change(this.checked?"add":"del",ref.env.cid,ref.env.source,this.value)})),this.gui_objects.editform?(this.enable_command("save",!0),"add"!=this.env.action&&"edit"!=this.env.action&&"search"!=this.env.action||this.init_contact_form()):"print"==this.env.action&&this.print_dialog();break;case"settings":this.enable_command("preferences","identities","responses","save","folders",!0),"identities"==this.env.action?this.enable_command("add",this.env.identities_level<2):"edit-identity"==this.env.action||"add-identity"==this.env.action?(this.enable_command("save","edit","toggle-editor",!0),this.enable_command("delete",this.env.identities_level<2),this.editor_init(this.env.editor_config,"rcmfd_signature")):"folders"==this.env.action?this.enable_command("subscribe","unsubscribe","create-folder","rename-folder",!0):"edit-folder"==this.env.action&&this.gui_objects.editform?(this.enable_command("save","folder-size",!0),parent.rcmail.env.exists=this.env.messagecount,parent.rcmail.enable_command("purge",this.env.messagecount)):"responses"==this.env.action&&this.enable_command("add",!0),this.gui_objects.identitieslist?(this.identity_list=new rcube_list_widget(this.gui_objects.identitieslist,{multiselect:!1,draggable:!1,keyboard:!0}),this.identity_list.addEventListener("select",function(a){ref.identity_select(a)}).addEventListener("keypress",function(a){a.key_pressed==a.ENTER_KEY&&ref.identity_select(a)}).init().focus()):this.gui_objects.sectionslist?(this.sections_list=new rcube_list_widget(this.gui_objects.sectionslist,{multiselect:!1,draggable:!1,keyboard:!0}),this.sections_list.addEventListener("select",function(a){ref.section_select(a)}).addEventListener("keypress",function(a){a.key_pressed==a.ENTER_KEY&&ref.section_select(a)}).init().focus()):this.gui_objects.subscriptionlist?this.init_subscription_list():this.gui_objects.responseslist&&(this.responses_list=new rcube_list_widget(this.gui_objects.responseslist,{multiselect:!1,draggable:!1,keyboard:!0}),this.responses_list.addEventListener("select",function(a){var b,c=a.get_single_selection();ref.enable_command("delete",!!c&&$.inArray(c,ref.env.readonly_responses)<0),c&&(b=ref.get_frame_window(ref.env.contentframe))&&(ref.set_busy(!0),ref.location_href({_action:"edit-response",_key:c,_framed:1},b))}).init().focus());break;case"login":var tz,tz_name,jstz=window.jstz,input_user=$("#rcmloginuser"),input_tz=$("#rcmlogintz");input_user.keyup(function(a){return ref.login_user_keyup(a)}),""==input_user.val()?input_user.focus():$("#rcmloginpwd").focus(),jstz&&(tz=jstz.determine())&&(tz_name=tz.name()),input_tz.val(tz_name||(new Date).getStdTimezoneOffset()/-60),$("form").submit(function(){$("input[type=submit]",this).prop("disabled",!0),ref.clear_messages(),ref.display_message("","loading")}),this.enable_command("login",!0)}this.gui_objects.editform&&$("input,select,textarea",this.gui_objects.editform).not(":hidden").not(":disabled").first().select().focus(),this.env.contentframe&&!$("#"+this.env.contentframe).is(":visible")&&(this.env.contentframe=null),bw.ie&&$("input[type=file]").keydown(function(a){"13"==a.keyCode&&a.preventDefault()}),this.loaded=!0,this.env.lastrefresh=new Date,this.pending_message&&this.display_message.apply(this,this.pending_message),this.gui_objects.folderlist&&window.rcube_treelist_widget&&this.gui_objects.folderlist!=this.gui_objects.addressbookslist&&(this.treelist=new rcube_treelist_widget(this.gui_objects.folderlist,{selectable:!0,id_prefix:"rcmli",parent_focus:!0,id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode,check_droptarget:function(a){return!a.virtual&&ref.check_droptarget(a.id)}}),this.treelist.addEventListener("collapse",function(a){ref.folder_collapsed(a)}).addEventListener("expand",function(a){ref.folder_collapsed(a)}).addEventListener("beforeselect",function(a){return!ref.busy}).addEventListener("select",function(a){ref.triggerEvent("selectfolder",{folder:a.id,prefix:"rcmli"})})),this.gui_objects.filedrop&&this.env.filedrop&&(window.XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.sendAsBinary||window.FormData)&&($(document.body).on("dragover dragleave drop",function(a){return ref.document_drag_hover(a,"dragover"==a.type)}),$(this.gui_objects.filedrop).addClass("droptarget").on("dragover dragleave",function(a){return ref.file_drag_hover(a,"dragover"==a.type)}).get(0).addEventListener("drop",function(a){return ref.file_dropped(a)},!1));var body_mouseup=function(a){return ref.doc_mouse_up(a)};$(document.body).mouseup(body_mouseup).keydown(function(a){return ref.doc_keypress(a)}),rcube_webmail.set_iframe_events({mouseup:body_mouseup}),this.triggerEvent("init",{task:this.task,action:this.env.action});for(n in this.onloads)"string"==typeof this.onloads[n]?eval(this.onloads[n]):"function"==typeof this.onloads[n]&&this.onloads[n]();this.start_refresh(),this.start_keepalive()},this.log=function(a){window.console&&console.log&&console.log(a)},this.command=function(a,b,c,d){var e,f,g,h,i,j=!1;if(!c||!c.blur||d&&rcube_event.is_keyboard(d)||c.blur(),this.busy&&("reset-search"!=a||"search"!=this.last_command)&&!a.match(/^menu-/))return!1;if(c&&c.href&&String(c.href).indexOf("#")<0&&rcube_event.get_modifier(d))return!0;if(!this.commands[a])return this.is_framed()&&parent.rcmail.command(a,b),!1;if("mail"==this.task&&"compose"==this.env.action&&!this.env.server_error&&"save-pref"!=a&&$.inArray(a,this.env.compose_commands)<0){if(!this.env.is_sent&&this.cmp_hash!=this.compose_field_hash()&&!confirm(this.get_label("notsentwarning")))return!1;this.remove_compose_data(this.env.compose_id),this.compose_skip_unsavedcheck=!0}if(this.last_command=a,"function"==typeof this.command_handlers[a])return e=this.command_handlers[a](b,c,d),void 0!==e?e:!c;if("string"==typeof this.command_handlers[a])return e=window[this.command_handlers[a]](b,c,d),void 0!==e?e:!c;if(this.triggerEvent("actionbefore",{props:b,action:a,originalEvent:d}),void 0!==(e=this.triggerEvent("before"+a,b||d))){if(!1===e)return!1;b=e}switch(e=void 0,a){case"login":this.gui_objects.loginform&&this.gui_objects.loginform.submit();break;case"logout":case"mail":case"addressbook":case"settings":this.switch_task(a);break;case"about":this.redirect("?_task=settings&_action=about",!1);break;case"permaurl":if(c&&c.href&&c.target)return!0;this.env.permaurl&&(parent.location.href=this.env.permaurl);break;case"extwin":if("compose"==this.env.action){var k=this.gui_objects.messageform,l=this.open_window("");l&&(this.save_compose_form_local(),this.compose_skip_unsavedcheck=!0,$("input[name='_action']",k).val("compose"),k.action=this.url("mail/compose",{_id:this.env.compose_id,_extwin:1}),k.target=l.name,k.submit())}else this.open_window(this.env.permaurl,!0);break;case"change-format":h=this.env.permaurl+"&_format="+b,"preview"==this.env.action&&(h=h.replace(/_action=show/,"_action=preview")+"&_framed=1"),this.env.extwin&&(h+="&_extwin=1"),location.href=h;break;case"menu-open":if(b&&"attachmentmenu"==b.menu){var m=this.env.attachments[b.id];this.enable_command("open-attachment",m&&this.env.mimetypes&&$.inArray(m,this.env.mimetypes)>=0)}this.show_menu(b,b.show||void 0,d);break;case"menu-close":this.hide_menu(b,d);break;case"menu-save":return this.triggerEvent(a,{props:b,originalEvent:d}),!1;case"open":if(f=this.get_single_uid())return c.href=this.url("show",this.params_from_uid(f)),!0;break;case"close":this.env.extwin&&window.close();break;case"list":b&&""!=b&&this.reset_qsearch(!0),"compose"==this.env.action&&this.env.extwin?window.close():"mail"==this.task?(this.list_mailbox(b),this.set_button_titles()):"addressbook"==this.task&&this.list_contacts(b);break;case"set-listmode":this.set_list_options(null,void 0,void 0,"threads"==b?1:0);break;case"sort":var n=this.env.sort_order,o=this.env.disabled_sort_col?this.env.sort_col:b;this.env.disabled_sort_order||(n=this.env.sort_col==o&&"ASC"==n?"DESC":"ASC"),this.set_list_sorting(o,n),this.list_mailbox("","",o+"_"+n);break;case"nextpage":this.list_page("next");break;case"lastpage":this.list_page("last");break;case"previouspage":this.list_page("prev");break;case"firstpage":this.list_page("first");break;case"expunge":this.env.exists&&this.expunge_mailbox(this.env.mailbox);break;case"purge":case"empty-mailbox":this.env.exists&&this.purge_mailbox(this.env.mailbox);break;case"show":"mail"==this.task?!(f=this.get_single_uid())||this.env.uid&&f==this.env.uid||(this.env.mailbox==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:f,_mbox:this.env.mailbox}):this.show_message(f)):"addressbook"==this.task&&(!(g=b||this.get_single_cid())||"show"==this.env.action&&g==this.env.cid||this.load_contact(g,"show"));break;case"add":if("addressbook"==this.task)this.load_contact(0,"add");else if("settings"==this.task&&"responses"==this.env.action){var p;(p=this.get_frame_window(this.env.contentframe))&&(this.set_busy(!0),this.location_href({_action:"add-response",_framed:1},p))}else"settings"==this.task&&(this.identity_list.clear_selection(),this.load_identity(0,"add-identity"));break;case"edit":"addressbook"==this.task&&(g=this.get_single_cid())?this.load_contact(g,"edit"):"settings"==this.task&&b?this.load_identity(b,"edit-identity"):"mail"==this.task&&(f=this.get_single_uid())&&(h={_mbox:this.get_message_mailbox(f)},h[this.env.mailbox==this.env.drafts_mailbox&&"new"!=b?"_draft_uid":"_uid"]=f,this.open_compose_step(h));break;case"save":var q,k=this.gui_objects.editform;if(k){if("search"==this.env.action);else{if((q=$("input[name='_pagesize']",k))&&q.length&&isNaN(parseInt(q.val()))){alert(this.get_label("nopagesizewarning")),q.focus();break}if("reload"==b)k.action+="&_reload=1";else if("settings"==this.task&&this.env.identities_level%2==0&&(q=$("input[name='_email']",k))&&q.length&&!rcube_check_email(q.val())){alert(this.get_label("noemailwarning")),q.focus();break}$("input.placeholder").each(function(){this.value==this._placeholder&&(this.value="")})}parent.rcmail&&parent.rcmail.env.source&&(k.action=this.add_url(k.action,"_orig_source",parent.rcmail.env.source)),k.submit()}break;case"delete":"mail"==this.task?this.delete_messages(d):"addressbook"==this.task?this.delete_contacts():"settings"==this.task&&"responses"==this.env.action?this.delete_response():"settings"==this.task&&this.delete_identity();break;case"move":case"moveto":"mail"==this.task?this.move_messages(b,d):"addressbook"==this.task&&this.move_contacts(b);break;case"copy":"mail"==this.task?this.copy_messages(b,d):"addressbook"==this.task&&this.copy_contacts(b);break;case"mark":b&&this.mark_message(b);break;case"toggle_status":case"toggle_flag":i="toggle_flag"==a?"flagged":"read",(f=b)&&("flagged"==i?this.message_list.rows[f].flagged&&(i="unflagged"):this.message_list.rows[f].deleted?i="undelete":this.message_list.rows[f].unread||(i="unread"),this.mark_message(i,f));break;case"always-load":if(this.env.uid&&this.env.sender){this.add_contact(this.env.sender),setTimeout(function(){ref.command("load-images")},300);break}case"load-images":this.env.uid&&this.show_message(this.env.uid,!0,"preview"==this.env.action);break;case"load-attachment":case"open-attachment":case"download-attachment":var r="_mbox="+urlencode(this.env.mailbox)+"&_uid="+this.env.uid+"&_part="+b,m=this.env.attachments[b];if("download-attachment"!=a&&m&&this.env.mimetypes&&$.inArray(m,this.env.mimetypes)>=0&&this.open_window(this.env.comm_path+"&_action=get&"+r+"&_frame=1"))break;this.goto_url("get",r+"&_download=1",!1,!0);break;case"select-all":this.select_all_mode=!b,this.dummy_select=!0,"invert"==b?this.message_list.invert_selection():this.message_list.select_all("page"==b?"":b),this.dummy_select=null;break;case"select-none":this.select_all_mode=!1,this.message_list.clear_selection();break;case"expand-all":this.env.autoexpand_threads=1,this.message_list.expand_all();break;case"expand-unread":this.env.autoexpand_threads=2,this.message_list.collapse_all(),this.expand_unread();break;case"collapse-all":this.env.autoexpand_threads=0,this.message_list.collapse_all();break;case"nextmessage":this.env.next_uid&&this.show_message(this.env.next_uid,!1,"preview"==this.env.action);break;case"lastmessage":this.env.last_uid&&this.show_message(this.env.last_uid);break;case"previousmessage":this.env.prev_uid&&this.show_message(this.env.prev_uid,!1,"preview"==this.env.action);break;case"firstmessage":this.env.first_uid&&this.show_message(this.env.first_uid);break;case"compose":if(h={},"mail"==this.task)h={_mbox:this.env.mailbox,_search:this.env.search_request},b&&(h._to=b);else if("addressbook"==this.task){if(!(b&&b.indexOf("@")>0)){var s=[];b?s.push(b):this.contact_list&&(s=this.contact_list.get_selection()),s.length?this.http_post("mailto",{_cid:s.join(","),_source:this.env.source},!0):this.env.group&&this.http_post("mailto",{_gid:this.env.group,_source:this.env.source},!0);break}h._to=b}else b&&"string"==typeof b?h._to=b:b&&"object"==typeof b&&$.extend(h,b);this.open_compose_step(h);break;case"spellcheck":this.spellcheck_state()?this.editor.spellcheck_stop():this.editor.spellcheck_start();break;case"savedraft":if(clearTimeout(this.save_timer),this.env.draft_id&&this.cmp_hash==this.compose_field_hash()){this.auto_save_start();break}this.submit_messageform(!0);break;case"send":if(!b.nocheck&&!this.env.is_sent&&!this.check_compose_input(a))break;clearTimeout(this.save_timer),this.submit_messageform();break;case"send-attachment":clearTimeout(this.save_timer),(i=this.upload_file(b||this.gui_objects.uploadform,"upload"))||(!1!==i&&alert(this.get_label("selectimportfile")),j=!0);break;case"insert-sig":this.change_identity($("[name='_from']")[0],!0);break;case"list-addresses":this.list_contacts(b),this.enable_command("add-recipient",!1);break;case"add-recipient":this.compose_add_recipient(b);break;case"reply-all":case"reply-list":case"reply":(f=this.get_single_uid())&&(h={_reply_uid:f,_mbox:this.get_message_mailbox(f),_search:this.env.search_request},"reply-all"==a?h._all=!b&&1==this.env.reply_all_mode&&this.commands["reply-list"]?"list":"all":"reply-list"==a&&(h._all="list"),this.open_compose_step(h));break;case"forward-attachment":case"forward-inline":case"forward":var t=this.env.uid?[this.env.uid]:this.message_list?this.message_list.get_selection():[];t.length&&(h={_forward_uid:this.uids_to_list(t),_mbox:this.env.mailbox,_search:this.env.search_request},("forward-attachment"==a||!b&&this.env.forward_attachment||t.length>1)&&(h._attachment=1),this.open_compose_step(h));break;case"print":"addressbook"==this.task?(f=this.contact_list.get_single_selection())&&(h="&_action=print&_cid="+f,this.env.source&&(h+="&_source="+urlencode(this.env.source)),this.open_window(this.env.comm_path+h,!0,!0)):"get"==this.env.action?this.gui_objects.messagepartframe.contentWindow.print():(f=this.get_single_uid())&&(h=this.url("print",this.params_from_uid(f,{_safe:this.env.safemode?1:0})),this.open_window(h,!0,!0)&&"show"!=this.env.action&&this.mark_message("read",f));break;case"viewsource":(f=this.get_single_uid())&&this.open_window(this.url("viewsource",this.params_from_uid(f)),!0,!0);break;case"download":"get"==this.env.action?location.href=this.secure_url(location.href.replace(/_frame=/,"_download=")):(f=this.get_single_uid())&&this.goto_url("viewsource",this.params_from_uid(f,{_save:1}),!1,!0);break;case"search":if(!b&&this.gui_objects.qsearchbox&&(b=this.gui_objects.qsearchbox.value),b){this.qsearch(b);break}case"reset-search":var u,v=this.env.search_request||this.env.qsearch;if(this.reset_qsearch(!0),v&&"compose"==this.env.action)this.contact_list&&this.list_contacts_clear();else if(v&&this.env.mailbox)this.list_mailbox(this.env.mailbox,1);else if(v&&"addressbook"==this.task){if(""==this.env.source){for(u in this.env.address_sources)break;this.env.source=u,this.env.group=""}this.list_contacts(this.env.source,this.env.group,1)}break;case"pushgroup":var w={id:b.id,search_request:this.env.search_request,page:this.env.current_page,search:this.env.search_request&&this.gui_objects.qsearchbox?this.gui_objects.qsearchbox.value:null};this.env.address_group_stack.push(w),c&&d&&rcube_event.cancel(d);case"listgroup":this.reset_qsearch(),this.list_contacts(b.source,b.id,1,w);break;case"popgroup":if(this.env.address_group_stack.length){var x=this.env.address_group_stack.pop();this.reset_qsearch(),x.search_request?(x.search&&this.gui_objects.qsearchbox&&$(this.gui_objects.qsearchbox).val(x.search),this.env.search_request=x.search_request,this.list_contacts_remote(null,null,this.env.current_page=x.page)):this.list_contacts(b.source,this.env.address_group_stack[this.env.address_group_stack.length-1].id)}break;case"import-messages":var k=b||this.gui_objects.importform,y=this.set_busy(!0,"importwait");$('input[name="_unlock"]',k).val(y),(i=this.upload_file(k,"import",y))||(this.set_busy(!1,null,y),!1!==i&&alert(this.get_label("selectimportfile")),j=!0);break;case"import":if("import"==this.env.action&&this.gui_objects.importform){var z=document.getElementById("rcmimportfile");if(z&&!z.value){alert(this.get_label("selectimportfile")),j=!0;break}this.gui_objects.importform.submit(),this.set_busy(!0,"importwait"),this.lock_form(this.gui_objects.importform,!0)}else this.goto_url("import",this.env.source?"_target="+urlencode(this.env.source)+"&":"");break;case"export":this.contact_list.rowcount>0&&this.goto_url("export",{_source:this.env.source,_gid:this.env.group,_search:this.env.search_request},!1,!0);break;case"export-selected":this.contact_list.rowcount>0&&this.goto_url("export",{_source:this.env.source,_gid:this.env.group,_cid:this.contact_list.get_selection().join(",")},!1,!0);break;case"upload-photo":this.upload_contact_photo(b||this.gui_objects.uploadform);break;case"delete-photo":this.replace_contact_photo("-del-");break;case"preferences":case"identities":case"responses":case"folders":this.goto_url("settings/"+a);break;case"undo":this.http_request("undo","",this.display_message("","loading"));break;default:var A=a.replace(/-/g,"_");this[A]&&"function"==typeof this[A]&&(e=this[A](b,c,d))}return j||!1!==this.triggerEvent("after"+a,b)||(e=!1),this.triggerEvent("actionafter",{props:b,action:a,aborted:j,ret:e}),!1!==e&&!c},this.enable_command=function(){var a,b,e,c=Array.prototype.slice.call(arguments),d=c.pop();for(b=0;b<c.length;b++)if("string"==typeof(e=c[b]))this.commands[e]=d,this.set_button(e,d?"act":"pas"),this.triggerEvent("enable-command",{command:e,status:d});else for(a in e)c.push(e[a])},this.command_enabled=function(a){return this.commands[a]},this.set_busy=function(a,b,c){if(a&&b){var d=this.get_label(b);d==b&&(d="Loading..."),c=this.display_message(d,"loading")}else!a&&c&&this.hide_message(c);return this.busy=a,this.gui_objects.editform&&this.lock_form(this.gui_objects.editform,a),c},this.get_label=function(a,b){return b&&this.labels[b+"."+a]?this.labels[b+"."+a]:this.labels[a]?this.labels[a]:a},this.gettext=this.get_label,this.switch_task=function(a){if(this.task!==a||"mail"==a){var b=this.get_task_url(a);"mail"==a?b+="&_mbox=INBOX":"logout"!=a||this.env.server_error||(b=this.secure_url(b),this.clear_compose_data()),this.redirect(b)}},this.get_task_url=function(a,b){return b||(b=this.env.comm_path),b.match(/[?&]_task=[a-zA-Z0-9_-]+/)?b.replace(/_task=[a-zA-Z0-9_-]+/,"_task="+a):b.replace(/\?.*$/,"")+"?_task="+a},this.reload=function(a){this.is_framed()?parent.rcmail.reload(a):a?setTimeout(function(){ref.reload()},a):window.location&&(location.href=this.url("",{_extwin:this.env.extwin}))},this.add_url=function(a,b,c){if(c=urlencode(c),/(\?.*)$/.test(a)){var d=RegExp.$1,e=RegExp("((\\?|&)"+RegExp.escape(b)+"=[^&]*)");return e.test(d)?d=d.replace(e,RegExp.$2+b+"="+c):d+="&"+b+"="+c,a.replace(/(\?.*)$/,d)}return a+"?"+b+"="+c},this.secure_url=function(a){return this.add_url(a,"_token",this.env.request_token)},this.is_framed=function(){return this.env.framed&&parent.rcmail&&parent.rcmail!=this&&"function"==typeof parent.rcmail.command},this.save_pref=function(a){var b={_name:a.name,_value:a.value};a.session&&(b._session=a.session),a.env&&(this.env[a.env]=a.value),this.http_post("save-pref",b)},this.html_identifier=function(a,b){return b?this.html_identifier_encode(a):String(a).replace(this.identifier_expr,"_")},this.html_identifier_encode=function(a){return Base64.encode(String(a)).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_")},this.html_identifier_decode=function(a){for(a=String(a).replace(/-/g,"+").replace(/_/g,"/");a.length%4;)a+="=";return Base64.decode(a)},this.drag_menu=function(a,b){var c=rcube_event.get_modifier(a),d=this.gui_objects.dragmenu;if(d&&c==SHIFT_KEY&&this.commands.copy){var e=rcube_event.get_mouse_pos(a);return this.env.drag_target=b,this.show_menu(this.gui_objects.dragmenu.id,!0,a),$(d).css({top:e.y-10+"px",left:e.x-10+"px"}),!0}return!1},this.drag_menu_action=function(a){var b=this.gui_objects.dragmenu;b&&$(b).hide(),this.command(a,this.env.drag_target),this.env.drag_target=null},this.drag_start=function(a){this.drag_active=!0,this.preview_timer&&clearTimeout(this.preview_timer),this.preview_read_timer&&clearTimeout(this.preview_read_timer),this.treelist&&this.treelist.drag_start()},this.drag_end=function(a){var b,c;if(this.treelist&&this.treelist.drag_end(),(b=this.message_list)?c=this.env.mailboxes:(b=this.contact_list)&&(c=this.env.contactfolders),this.drag_active&&c&&this.env.last_folder_target){var d=c[this.env.last_folder_target];b.draglayer.hide(),this.contact_list?this.contacts_drag_menu(a,d)||this.command("move",d):this.drag_menu(a,d)||this.command("move",d)}this.drag_active=!1,this.env.last_folder_target=null},this.drag_move=function(a){if(this.gui_objects.folderlist){var b,c,d="draglayernormal",e=rcube_event.get_mouse_pos(a);this.contact_list&&this.contact_list.draglayer&&(c=this.contact_list.draglayer.attr("class")),this.treelist&&(b=this.treelist.intersects(e,!0))?(this.env.last_folder_target=b,d="draglayer"+(this.check_droptarget(b)>1?"copy":"normal")):this.env.last_folder_target=null,d!=c&&this.contact_list&&this.contact_list.draglayer&&this.contact_list.draglayer.attr("class",d)}},this.collapse_folder=function(a){this.treelist&&this.treelist.toggle(a)},this.folder_collapsed=function(a){var b="addressbook"==this.env.task?"collapsed_abooks":"collapsed_folders",c=this.env[b];if(a.collapsed)this.env[b]=this.env[b]+"&"+urlencode(a.id)+"&",!a.virtual&&this.env.mailbox&&this.env.mailbox.startsWith(a.id+this.env.delimiter)&&this.command("list",a.id);else{var d=new RegExp("&"+urlencode(a.id)+"&");this.env[b]=this.env[b].replace(d,"")}this.drag_active||(c!==this.env[b]&&this.command("save-pref",{name:b,value:this.env[b]}),this.env.unread_counts&&this.set_unread_count_display(a.id,!1))},this.doc_mouse_up=function(a){var c,d=rcube_event.get_target(a);if(!$(d).closest(".ui-dialog, .ui-widget-overlay").length){if(window.rcube_list_widget&&rcube_list_widget._instances.length&&$.each(rcube_list_widget._instances,function(b,c){c&&!rcube_mouse_is_over(a,c.list.parentNode)&&c.blur()}),this.buttons_sel){for(c in this.buttons_sel)"function"!=typeof c&&this.button_out(this.buttons_sel[c],c);this.buttons_sel={}}setTimeout(function(a){var b,c,f,g,h=$(d).parents();for(g=ref.menu_stack.length-1;g>=0;g--)f=ref.menu_stack[g],b=$("#"+f),!b.is(":visible")||d==b.data("opener")||d==b.get(0)||h.is(b.data("opener"))||f==c||"true"==b.attr("data-editable")&&$(d).parents("#"+f).length||"true"==b.attr("data-sticky")&&rcube_mouse_is_over(a,b.get(0))||ref.hide_menu(f,a),c=b.data("parent")},10,a)}},this.doc_keypress=function(a){var b=function(a){var b,c,d=a<0?"prevAll":"nextAll",e=a<0?"last":"first";return ref.focused_menu&&(b=$("#"+ref.focused_menu))?(c=b.find(":focus").closest("li")[d](":has(:not([aria-disabled=true]))").find("a,input")[e](),c.length||(c=b.find(":focus").closest("ul")[d](":has(:not([aria-disabled=true]))").find("a,input")[e]()),c.focus().length):0},c=a.target||{},d=rcube_event.get_keycode(a);if(rcube_event._last_keyboard_event=a,27!=a.keyCode&&(!this.menu_keyboard_active||"TEXTAREA"==c.nodeName||"SELECT"==c.nodeName))return!0;switch(d){case 38:case 40:case 63232:case 63233:return b(38==d||63232==d?-1:1),rcube_event.cancel(a);case 9:if(this.focused_menu){b(rcube_event.get_modifier(a)==SHIFT_KEY?-1:1)||this.hide_menu(this.focused_menu,a)}return rcube_event.cancel(a);case 27:this.menu_stack.length&&this.hide_menu(this.menu_stack[this.menu_stack.length-1],a)}return!0},this.msglist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer),this.preview_read_timer&&clearTimeout(this.preview_read_timer);var b=a.get_single_selection();if(this.enable_command(this.env.message_commands,null!=b),b)if(this.env.mailbox==this.env.drafts_mailbox)this.enable_command("reply","reply-all","reply-list","forward","forward-attachment","forward-inline",!1);else{var c=this.env.messages[b];c.ml||this.enable_command("reply-list",!1)}this.enable_command("delete","move","copy","mark","forward","forward-attachment",a.selection.length>0),(b||a.selection.length&&a.selection.length!=a.rowcount)&&(this.select_all_mode=!1),b&&this.env.contentframe&&!a.multi_selecting&&!this.dummy_select?this.preview_timer=setTimeout(function(){ref.msglist_get_preview()},this.dblclick_time):this.env.contentframe&&this.show_contentframe(!1)},this.msglist_click=function(a){if(!a.multi_selecting&&this.env.contentframe&&!a.get_single_selection()){var b=this.get_frame_window(this.env.contentframe);b&&b.location.href.indexOf(this.env.blankpage)>=0&&(this.preview_timer&&clearTimeout(this.preview_timer),this.preview_read_timer&&clearTimeout(this.preview_read_timer),this.preview_timer=setTimeout(function(){ref.msglist_get_preview()},this.dblclick_time))}},this.msglist_dbl_click=function(a){this.preview_timer&&clearTimeout(this.preview_timer),this.preview_read_timer&&clearTimeout(this.preview_read_timer);var b=a.get_single_selection();b&&(this.env.messages[b].mbox||this.env.mailbox)==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:b,_mbox:this.env.mailbox}):b&&this.show_message(b,!1,!1)},this.msglist_keypress=function(a){a.modkey!=CONTROL_KEY&&(a.key_pressed==a.ENTER_KEY?this.command("show"):a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY?this.command("delete"):33==a.key_pressed?this.command("previouspage"):34==a.key_pressed&&this.command("nextpage"))},this.msglist_get_preview=function(){var a=this.get_single_uid();a&&this.env.contentframe&&!this.drag_active?this.show_message(a,!1,!0):this.env.contentframe&&this.show_contentframe(!1)},this.msglist_expand=function(a){this.env.messages[a.uid]&&(this.env.messages[a.uid].expanded=a.expanded),$(a.obj)[a.expanded?"addClass":"removeClass"]("expanded")},this.msglist_set_coltypes=function(a){var b,c,d,e=a.thead.rows[0].cells;for(this.env.listcols=[],b=0;b<e.length;b++)e[b].id&&e[b].id.startsWith("rcm")&&(d=e[b].id.slice(3),this.env.listcols.push(d));(c=$.inArray("flag",this.env.listcols))>=0&&(this.env.flagged_col=c),(c=$.inArray("subject",this.env.listcols))>=0&&(this.env.subject_col=c),this.command("save-pref",{name:"list_cols",value:this.env.listcols,session:"list_attrib/columns"})},this.check_droptarget=function(a){switch(this.task){case"mail":return!this.env.mailboxes[a]||this.env.mailboxes[a].virtual||this.env.mailboxes[a].id==this.env.mailbox&&!this.is_multifolder_listing()?0:1;case"addressbook":var b;if(a!=this.env.source&&(b=this.env.contactfolders[a]))if("group"==b.type){if(b.id!=this.env.group&&!this.env.contactfolders[b.source].readonly){var c=this.env.selection_sources.length>1||-1==$.inArray(b.source,this.env.selection_sources);return!c||this.commands.move?1:2}}else if(!b.readonly&&(this.env.selection_sources.length>1||-1==$.inArray(a,this.env.selection_sources)))return this.commands.move?1:2}return 0},this.open_window=function(a,b,c){var d="rcmextwin"+(new Date).getTime();if(a+=(a.match(/\?/)?"&":"?")+"_extwin=1",this.env.standard_windows)var e=window.open(a,d);else var f=this.is_framed()?parent.window:window,g=$(f),h=g.width(),i=bw.mz?$("body",f).height():g.height(),j=Math.min(b?this.env.popup_width_small:this.env.popup_width,h),k=i,l=(f.screenLeft||f.screenX)+20,m=(f.screenTop||f.screenY)+20,e=window.open(a,d,"width="+j+",height="+k+",top="+m+",left="+l+",resizable=yes,location=no,scrollbars=yes"+(c?",toolbar=yes,menubar=yes,status=yes":",toolbar=no,menubar=no,status=no"));return!e||e.closed?void this.display_message(this.get_label("windowopenerror"),"warning"):(!a&&e.document&&e.document.write("<html><body>"+this.get_label("loading")+"</body></html>"),this.triggerEvent("openwindow",{url:a,handle:e}),setTimeout(function(){e&&e.focus()},10),e)},this.init_message_row=function(a){var c={},d=a.uid,e=(null!=this.env.status_col?"status":"msg")+"icn"+a.id;d&&this.env.messages[d]&&$.extend(a,this.env.messages[d]),(a.icon=document.getElementById(e))&&(c.icon=function(a){ref.command("toggle_status",d)}),null!=this.env.status_col?a.msgicon=document.getElementById("msgicn"+a.id):a.msgicon=a.icon,null!=this.env.flagged_col&&(a.flagicon=document.getElementById("flagicn"+a.id))&&(c.flagicon=function(a){ref.command("toggle_flag",d)}),!a.depth&&a.has_children&&(a.expando=document.getElementById("rcmexpando"+a.id))&&(c.expando=function(a){ref.expand_message_row(a,d)}),$.each(c,function(b,c){a[b].onclick=function(a){return c(a),rcube_event.cancel(a)},bw.touch&&a[b].addEventListener&&a[b].addEventListener("touchend",function(a){if(1==a.changedTouches.length)return c(a),rcube_event.cancel(a)},!1)}),this.triggerEvent("insertrow",{uid:d,row:a})},this.add_message_row=function(a,b,c,d){if(!this.gui_objects.messagelist||!this.message_list)return!1;if(c.mbox!=this.env.mailbox&&!c.skip_mbox_check)return!1;this.env.messages[a]||(this.env.messages[a]={}),$.extend(this.env.messages[a],{deleted:c.deleted?1:0,replied:c.answered?1:0,unread:c.seen?0:1,forwarded:c.forwarded?1:0,flagged:c.flagged?1:0,has_children:c.has_children?1:0,depth:c.depth?c.depth:0,unread_children:c.unread_children?c.unread_children:0,parent_uid:c.parent_uid?c.parent_uid:0,selected:this.select_all_mode||this.message_list.in_selection(a),ml:c.ml?1:0,ctype:c.ctype,mbox:c.mbox,flags:c.extra_flags});var e,f,g,h,i,j,k="",l="",m="",n="",o=this.message_list,p=o.rows,q=this.env.messages[a],r=this.html_identifier(a,!0),s="message"+(c.seen?"":" unread")+(c.deleted?" deleted":"")+(c.flagged?" flagged":"")+(q.selected?" selected":""),t={cols:[],style:{},id:"rcmrow"+r,uid:a};if(i="msgicon",null===this.env.status_col&&(i+=" status",c.deleted?(k+=" deleted",l+=this.get_label("deleted")+" "):c.seen?c.unread_children>0&&(k+=" unreadchildren"):(k+=" unread",l+=this.get_label("unread")+" ")),c.answered&&(k+=" replied",l+=this.get_label("replied")+" "),c.forwarded&&(k+=" forwarded",l+=this.get_label("forwarded")+" "),q.selected&&!o.in_selection(a)&&o.selection.push(a),this.env.threading&&(q.depth?(m+='<span id="rcmtab'+r+'" class="branch" style="width:'+15*q.depth+'px;">&nbsp;&nbsp;</span>',p[q.parent_uid]&&!1===p[q.parent_uid].expanded||!(0!=this.env.autoexpand_threads&&2!=this.env.autoexpand_threads||p[q.parent_uid]&&p[q.parent_uid].expanded)?(t.style.display="none",q.expanded=!1):q.expanded=!0,s+=" thread expanded"):q.has_children&&(void 0===q.expanded&&(1==this.env.autoexpand_threads||2==this.env.autoexpand_threads&&q.unread_children)&&(q.expanded=!0),n='<div id="rcmexpando'+t.id+'" class="'+(q.expanded?"expanded":"collapsed")+'">&nbsp;&nbsp;</div>',s+=" thread"+(q.expanded?" expanded":"")),c.unread_children&&c.seen&&!q.expanded&&(s+=" unroot")),m+='<span id="msgicn'+t.id+'" class="'+i+k+'" title="'+l+'"></span>',t.className=s,b.subject){var u=c.mbox==this.env.drafts_mailbox?"compose":"show",v=c.mbox==this.env.drafts_mailbox?"_draft_uid":"_uid",w={_mbox:c.mbox};w[v]=a,b.subject='<a href="'+this.url(u,w)+'" onclick="return rcube_event.keyboard_only(event)" onmouseover="rcube_webmail.long_subject_title(this,'+(q.depth+1)+')" tabindex="-1"><span>'+b.subject+"</span></a>"}for(f in this.env.listcols)e=this.env.listcols[f],g={className:String(e).toLowerCase(),events:{}},this.env.coltypes[e]&&this.env.coltypes[e].hidden&&(g.className+=" hidden"),"flag"==e?(i=c.flagged?"flagged":"unflagged",j=this.get_label(i),h='<span id="flagicn'+t.id+'" class="'+i+'" title="'+j+'"></span>'):"attachment"==e?(j=this.get_label("withattachment"),h=c.attachmentClass?'<span class="'+c.attachmentClass+'" title="'+j+'"></span>':/application\/|multipart\/(m|signed)/.test(c.ctype)?'<span class="attachment" title="'+j+'"></span>':/multipart\/report/.test(c.ctype)?'<span class="report"></span>':"&nbsp;"):"status"==e?(j="",c.deleted?(i="deleted",j=this.get_label("deleted")):c.seen?i=c.unread_children>0?"unreadchildren":"msgicon":(i="unread",j=this.get_label("unread")),h='<span id="statusicn'+t.id+'" class="'+i+k+'" title="'+j+'"></span>'):"threads"==e?h=n:"subject"==e?(bw.ie&&(g.events.mouseover=function(){rcube_webmail.long_subject_title_ex(this)}),h=m+b[e]):"priority"==e?c.prio>0&&c.prio<6?(j=this.get_label("priority")+" "+c.prio,h='<span class="prio'+c.prio+'" title="'+j+'"></span>'):h="&nbsp;":h="folder"==e?'<span onmouseover="rcube_webmail.long_subject_title(this)">'+b[e]+"<span>":b[e],g.innerHTML=h,t.cols.push(g);if(o.insert_row(t,d),d&&this.env.pagesize&&o.rowcount>this.env.pagesize){var a=o.get_last_row();o.remove_row(a),o.clear_selection(a)}},this.set_list_sorting=function(a,b){var c="arrival"==this.env.sort_col?"date":this.env.sort_col,d="arrival"==a?"date":a;$("#rcm"+c).removeClass("sorted"+this.env.sort_order.toUpperCase()),d&&$("#rcm"+d).addClass("sorted"+b),$("#rcmdate > a").prop("rel","arrival"==a?"arrival":"date"),this.env.sort_col=a,this.env.sort_order=b},this.set_list_options=function(a,b,c,d){var e,f={};if(void 0===b&&(b=this.env.sort_col),c||(c=this.env.sort_order),this.env.sort_col==b&&this.env.sort_order==c||(e=1,this.set_list_sorting(b,c)),this.env.threading!=d&&(e=1,f._threads=d),a&&a.length){var g,h,i,j=[],k=this.env.listcols;for(g=0;g<k.length;g++)i=k[g],-1!=(h=$.inArray(i,a))&&(j.push(i),delete a[h]);for(g=0;g<a.length;g++)a[g]&&j.push(a[g]);j.join()!=k.join()&&(e=1,f._cols=j.join(","))}e&&this.list_mailbox("","",b+"_"+c,f)},this.show_message=function(a,b,c){if(a){var d,e=window,f=this.params_from_uid(a,{_caps:this.browser_capabilities()});c&&(d=this.get_frame_window(this.env.contentframe))&&(e=d,f._framed=1),b&&(f._safe=1),this.env.search_request&&(f._search=this.env.search_request),this.env.extwin&&(f._extwin=1),f=this.url(c?"preview":"show",f),c&&String(e.location.href).indexOf(f)>=0?this.show_contentframe(!0):(c||!this.env.message_extwin||this.env.extwin?this.location_href(f,e,!0):this.open_window(f,!0),c&&this.message_list&&this.message_list.rows[a]&&this.message_list.rows[a].unread&&this.env.preview_pane_mark_read>0&&(this.preview_read_timer=setTimeout(function(){ref.set_unread_message(a,ref.env.mailbox),ref.http_post("mark",{_uid:a,_flag:"read",_mbox:ref.env.mailbox,_quiet:1})},1e3*this.env.preview_pane_mark_read)))}},this.set_unread_message=function(a,b){var c=this;c.message_list||(c=c.opener()),!c&&window.parent&&(c=parent.rcmail),c&&c.message_list&&(!1===c.set_message(a,"unread",!1)&&c.set_message(a+"-"+b,"unread",!1),c.env.unread_counts[b]>0&&(c.env.unread_counts[b]-=1,c.set_unread_count(b,c.env.unread_counts[b],"INBOX"==b&&!c.is_multifolder_listing())))},this.show_contentframe=function(a){var b,c,d=this.env.contentframe;d&&(b=this.get_frame_element(d))&&(!a&&(c=this.get_frame_window(d))?c.location.href.indexOf(this.env.blankpage)<0&&(c.stop?c.stop():c.document.execCommand("Stop"),c.location.href=this.env.blankpage):bw.safari||bw.konq||$(b)[a?"show":"hide"]()),!a&&this.env.frame_lock&&this.set_busy(!1,null,this.env.frame_lock)},this.get_frame_element=function(a){var b;if(a&&(b=document.getElementById(a)))return b},this.get_frame_window=function(a){var b=this.get_frame_element(a);if(b&&b.name&&window.frames)return window.frames[b.name]},this.lock_frame=function(){this.env.frame_lock||((this.is_framed()?parent.rcmail:this).env.frame_lock=this.set_busy(!0,"loading"))},this.list_page=function(a){"next"==a?a=this.env.current_page+1:"last"==a?a=this.env.pagecount:"prev"==a&&this.env.current_page>1?a=this.env.current_page-1:"first"==a&&this.env.current_page>1&&(a=1),a>0&&a<=this.env.pagecount&&(this.env.current_page=a,"addressbook"==this.task||this.contact_list?this.list_contacts(this.env.source,this.env.group,a):"mail"==this.task&&this.list_mailbox(this.env.mailbox,a))},this.checkmail=function(){var a=this.set_busy(!0,"checkingmail"),b=this.check_recent_params();this.http_post("check-recent",b,a)},this.filter_mailbox=function(a){if(!this.filter_disabled){var b=this.set_busy(!0,"searching");this.clear_message_list(),this.env.current_page=1,this.env.search_filter=a,this.http_request("search",this.search_params(!1,a),b)}},this.refresh_list=function(){this.list_mailbox(this.env.mailbox,this.env.current_page||1,null,{_clear:1},!0),this.message_list&&this.message_list.clear_selection()},this.list_mailbox=function(a,b,c,d,e){var f,g=window;if("object"!=typeof d&&(d={}),a||(a=this.env.mailbox?this.env.mailbox:"INBOX"),c&&(d._sort=c),this.env.mailbox!=a?(b=1,this.env.current_page=b,this.env.search_scope="base",this.select_all_mode=!1,this.reset_search_filter()):this.env.search_request&&(d._search=this.env.search_request),e||(this.clear_message_list(),a==this.env.mailbox&&(a!=this.env.mailbox||b||c)||(d._refresh=1),this.select_folder(a,"",!0),this.unmark_folder(a,"recent","",!0),this.env.mailbox=a),this.gui_objects.messagelist)return void this.list_mailbox_remote(a,b,d);(f=this.get_frame_window(this.env.contentframe))&&(g=f,d._framed=1),this.env.uid&&(d._uid=this.env.uid),a&&(this.set_busy(!0,"loading"),d._mbox=a,b&&(d._page=b),this.location_href(d,g))},this.clear_message_list=function(){this.env.messages={},this.show_contentframe(!1),this.message_list&&this.message_list.clear(!0)},this.list_mailbox_remote=function(a,b,c){var d=this.set_busy(!0,"loading");"object"!=typeof c&&(c={}),c._mbox=a,b&&(c._page=b),this.http_request("list",c,d),this.env.ismobile||this.update_state({_mbox:a,_page:b&&b>1?b:null})},this.update_selection=function(){var d,a=this.message_list,b=a.selection,c=a.rows,e=[];for(d in b)c[b[d]]&&e.push(b[d]);a.selection=e;try{var f=this.get_frame_window(this.env.contentframe),g=f.rcmail.env.uid;g&&!a.in_selection(g)&&this.show_contentframe(!1)}catch(a){}},this.expand_unread=function(){for(var a,b=this.message_list.tbody,c=b.firstChild;c;)1==c.nodeType&&(a=this.message_list.rows[c.uid])&&a.unread_children&&(this.message_list.expand_all(a),this.set_unread_children(a.uid)),c=c.nextSibling;return!1},this.expand_message_row=function(a,b){var c=this.message_list.rows[b];c.expanded=!c.expanded,this.set_unread_children(b),c.expanded=!c.expanded,this.message_list.expand_row(a,b)},this.expand_threads=function(){if(this.env.threading&&this.env.autoexpand_threads&&this.message_list)switch(this.env.autoexpand_threads){case 2:this.expand_unread();break;case 1:this.message_list.expand_all()}},this.init_threads=function(a,b){if(b&&b!=this.env.mailbox)return!1;for(var c=0,d=a.length;c<d;c++)this.add_tree_icons(a[c]);this.expand_threads()},this.add_tree_icons=function(a){var b,d,f,g,j,h=[],i=[],k=this.message_list.rows;for(j=a?k[a]?k[a].obj:null:this.message_list.tbody.firstChild;j;){if(1==j.nodeType&&(d=k[j.uid]))if(d.depth){for(b=h.length-1;b>=0&&(f=h[b].length,f>d.depth?(g=f-d.depth,2&h[b][g]||(h[b][g]=h[b][g]?h[b][g]+2:2)):f==d.depth&&(2&h[b][0]||(h[b][0]+=2)),!(d.depth>f));b--);h.push(new Array(d.depth)),h[h.length-1][0]=1,i.push(d.uid)}else{if(h.length){for(b in h)this.set_tree_icons(i[b],h[b]);h=[],i=[]}if(a&&j!=k[a].obj)break}j=j.nextSibling}if(h.length)for(b in h)this.set_tree_icons(i[b],h[b])},this.set_tree_icons=function(a,b){var c,d=[],e="",f=b.length;for(c=0;c<f;c++)b[c]>2?d.push({class:"l3",width:15}):b[c]>1?d.push({class:"l2",width:15}):b[c]>0?d.push({class:"l1",width:15}):d.length&&!d[d.length-1].class?d[d.length-1].width+=15:d.push({class:null,width:15});for(c=d.length-1;c>=0;c--)d[c].class?e+='<div class="tree '+d[c].class+'" />':e+='<div style="width:'+d[c].width+'px" />';e&&$("#rcmtab"+this.html_identifier(a,!0)).html(e)},this.update_thread_root=function(a,b){if(this.env.threading){var c=this.message_list.find_root(a);if(a!=c){var d=this.message_list.rows[c];if("read"==b&&d.unread_children)d.unread_children--;else{if("unread"!=b||!d.has_children)return;d.unread_children=d.unread_children?d.unread_children+1:1}this.set_message_icon(c),this.set_unread_children(c)}}},this.update_thread=function(a){if(!this.env.threading)return 0;var b,c,d=0,e=this.message_list.rows,f=e[a],g=e[a].depth,h=[];for(f.depth?f.unread&&(c=this.message_list.find_root(a),e[c].unread_children--,this.set_unread_children(c)):d--,c=f.parent_uid,f=f.obj.nextSibling;f;){if(1==f.nodeType&&(b=e[f.uid])){if(!b.depth||b.depth<=g)break;b.depth--,$("#rcmtab"+b.id).width(15*b.depth).html(""),b.depth?(b.depth==g&&(b.parent_uid=c),b.unread&&h.length&&h[h.length-1].unread_children++):(d++,b.parent_uid=0,b.has_children&&($("#"+b.id+" .leaf:first").attr("id","rcmexpando"+b.id).attr("class","none"!=b.obj.style.display?"expanded":"collapsed").mousedown({uid:b.uid},function(a){return ref.expand_message_row(a,a.data.uid)}),b.unread_children=0,h.push(b)),"none"==b.obj.style.display&&$(b.obj).show())}f=f.nextSibling}for(b=0;b<h.length;b++)this.set_unread_children(h[b].uid);return d},this.delete_excessive_thread_rows=function(){for(var a=this.message_list.rows,b=this.message_list.tbody,c=b.firstChild,d=this.env.pagesize+1;c;)1==c.nodeType&&(r=a[c.uid])&&(!r.depth&&d&&d--,d||this.message_list.remove_row(c.uid)),c=c.nextSibling},this.set_message_icon=function(a){var b,c="",d=this.message_list.rows[a];if(!d)return!1;d.icon&&(b="msgicon",d.deleted?(b+=" deleted",c+=this.get_label("deleted")+" "):d.unread?(b+=" unread",c+=this.get_label("unread")+" "):d.unread_children&&(b+=" unreadchildren"),d.msgicon==d.icon&&(d.replied&&(b+=" replied",c+=this.get_label("replied")+" "),d.forwarded&&(b+=" forwarded",c+=this.get_label("forwarded")+" "),b+=" status"),$(d.icon).attr("class",b).attr("title",c)),d.msgicon&&d.msgicon!=d.icon&&(c="",b="msgicon",!d.unread&&d.unread_children&&(b+=" unreadchildren"),d.replied&&(b+=" replied",c+=this.get_label("replied")+" "),d.forwarded&&(b+=" forwarded",c+=this.get_label("forwarded")+" "),$(d.msgicon).attr("class",b).attr("title",c)),d.flagicon&&(b=d.flagged?"flagged":"unflagged",c=this.get_label(b),$(d.flagicon).attr("class",b).attr("aria-label",c).attr("title",c))},this.set_message_status=function(a,b,c){var d=this.message_list.rows[a];if(!d)return!1;"unread"==b&&d.unread!=c&&this.update_thread_root(a,c?"unread":"read"),$.inArray(b,["unread","deleted","replied","forwarded","flagged"])>-1&&(d[b]=c)},this.set_message=function(a,b,c){var d=this.message_list&&this.message_list.rows[a];if(!d)return!1;b&&this.set_message_status(a,b,c),$.inArray(b,["unread","deleted","flagged"])>-1&&$(d.obj)[d[b]?"addClass":"removeClass"](b),this.set_unread_children(a),this.set_message_icon(a)},this.set_unread_children=function(a){var b=this.message_list.rows[a];b.parent_uid||(b.unread||!b.unread_children||b.expanded?$(b.obj).removeClass("unroot"):$(b.obj).addClass("unroot"))},this.copy_messages=function(a,b){if(a&&"object"==typeof a)a=a.id;else if(!a)return this.folder_selector(b,function(a){ref.command("copy",a)});if(a&&a!=this.env.mailbox){var c=this.selection_post_data({_target_mbox:a});c._uid&&this.http_post("copy",c,this.display_message(this.get_label("copyingmessage"),"loading"))}},this.move_messages=function(a,b){if(a&&"object"==typeof a)a=a.id;else if(!a)return this.folder_selector(b,function(a){ref.command("move",a)});if(a&&(a!=this.env.mailbox||this.is_multifolder_listing())){var c=!1,d=this.selection_post_data({_target_mbox:a});d._uid&&("show"==this.env.action?c=this.set_busy(!0,"movingmessage"):this.show_contentframe(!1),this.enable_command(this.env.message_commands,!1),this._with_selected_messages("move",d,c))}},this.delete_messages=function(a){var b=this.message_list,c=this.env.trash_mailbox;return this.env.flag_for_deletion?(this.mark_message("delete"),!1):(c&&this.env.mailbox!=c?this.env.delete_junk&&this.env.junk_mailbox&&this.env.mailbox==this.env.junk_mailbox?this.permanently_remove_messages():b&&b.modkey==SHIFT_KEY||a&&rcube_event.get_modifier(a)==SHIFT_KEY?confirm(this.get_label("deletemessagesconfirm"))&&this.permanently_remove_messages():this.move_messages(c):this.permanently_remove_messages(),!0)},this.permanently_remove_messages=function(){var a=this.selection_post_data();a._uid&&(this.show_contentframe(!1),this._with_selected_messages("delete",a))},this._with_selected_messages=function(a,b,c){var e,d=0,f="delete"==a||!this.is_multifolder_listing();if(this.message_list){var g,h,i,j=[],k=this.message_list.get_selection();for(g=0,len=k.length;g<len;g++)h=k[g],this.env.threading&&(d+=this.update_thread(h),(i=this.message_list.find_root(h))!=h&&$.inArray(i,j)<0&&j.push(i)),f&&this.message_list.remove_row(h,this.env.display_next&&g==k.length-1);for(!this.env.display_next&&f&&this.message_list.clear_selection(),g=0,len=j.length;g<len;g++)this.add_tree_icons(j[g])}d<0?b._count=-1*d:d>0&&f&&this.delete_excessive_thread_rows(),f||(b._refresh=1),c||(e="move"==a?"movingmessage":"deletingmessage",c=this.display_message(this.get_label(e),"loading")),this.http_post(a,b,c)},this.selection_post_data=function(a){if("object"!=typeof a&&(a={}),a._mbox=this.env.mailbox,!a._uid){var b=this.env.uid?[this.env.uid]:this.message_list.get_selection();a._uid=this.uids_to_list(b)}return this.env.action&&(a._from=this.env.action),this.env.search_request&&(a._search=this.env.search_request),this.env.display_next&&this.env.next_uid&&(a._next_uid=this.env.next_uid),a},this.mark_message=function(a,b){var e,f,g,c=[],d=[],h=this.message_list;if(b?c[0]=b:this.env.uid?c[0]=this.env.uid:h&&(c=h.get_selection()),h)for(h.focus(),f=0,e=c.length;f<e;f++)g=c[f],("read"==a&&h.rows[g].unread||"unread"==a&&!h.rows[g].unread||"delete"==a&&!h.rows[g].deleted||"undelete"==a&&h.rows[g].deleted||"flagged"==a&&!h.rows[g].flagged||"unflagged"==a&&h.rows[g].flagged)&&d.push(g);else d=c;if(d.length||this.select_all_mode)switch(a){case"read":case"unread":this.toggle_read_status(a,d);break;case"delete":case"undelete":this.toggle_delete_status(d);break;case"flagged":case"unflagged":this.toggle_flagged_status(a,c)}},this.toggle_read_status=function(a,b){var c,d=b.length,e=this.selection_post_data({_uid:this.uids_to_list(b),_flag:a}),f=this.display_message(this.get_label("markingmessage"),"loading");for(c=0;c<d;c++)this.set_message(b[c],"unread","unread"==a);this.http_post("mark",e,f)},this.toggle_flagged_status=function(a,b){var c,d=b.length,e=this.selection_post_data({_uid:this.uids_to_list(b),_flag:a}),f=this.display_message(this.get_label("markingmessage"),"loading");for(c=0;c<d;c++)this.set_message(b[c],"flagged","flagged"==a);this.http_post("mark",e,f)},this.toggle_delete_status=function(a){var c,d,b=a.length,e=!0,f=this.message_list?this.message_list.rows:{};if(1==b)return!this.message_list||f[a[0]]&&!f[a[0]].deleted?this.flag_as_deleted(a):this.flag_as_undeleted(a),!0;for(c=0;c<b;c++)if(d=a[c],f[d]&&!f[d].deleted){e=!1;break}return e?this.flag_as_undeleted(a):this.flag_as_deleted(a),!0},this.flag_as_undeleted=function(a){var b,c=a.length,d=this.selection_post_data({_uid:this.uids_to_list(a),_flag:"undelete"}),e=this.display_message(this.get_label("markingmessage"),"loading");for(b=0;b<c;b++)this.set_message(a[b],"deleted",!1);this.http_post("mark",d,e)},this.flag_as_deleted=function(a){for(var b=[],c=this.selection_post_data({_uid:this.uids_to_list(a),_flag:"delete"}),d=this.display_message(this.get_label("markingmessage"),"loading"),e=this.message_list,f=e?e.rows:{},g=0,h=0,i=a.length;h<i;h++)uid=a[h],f[uid]&&(f[uid].unread&&(b[b.length]=uid),this.env.skip_deleted?(g+=this.update_thread(uid),e.remove_row(uid,this.env.display_next&&h==e.selection.length-1)):this.set_message(uid,"deleted",!0));this.env.skip_deleted&&e&&(this.env.display_next&&e.rowcount||e.clear_selection(),g<0?c._count=-1*g:g>0&&this.delete_excessive_thread_rows()),b.length&&(c._ruid=this.uids_to_list(b)),this.env.skip_deleted&&this.env.display_next&&this.env.next_uid&&(c._next_uid=this.env.next_uid),this.http_post("mark",c,d)},this.flag_deleted_as_read=function(a){var b,c,d,e=this.message_list?this.message_list.rows:{};for("string"==typeof a&&(a=a.split(",")),c=0,d=a.length;c<d;c++)b=a[c],e[b]&&this.set_message(b,"unread",!1)},this.uids_to_list=function(a){return this.select_all_mode?"*":a.length<=1?a.join(","):a},this.set_button_titles=function(){var a="deletemessage";this.env.flag_for_deletion||!this.env.trash_mailbox||this.env.mailbox==this.env.trash_mailbox||this.env.delete_junk&&this.env.junk_mailbox&&this.env.mailbox==this.env.junk_mailbox||(a="movemessagetotrash"),this.set_alttext("delete",a)},this.init_pagejumper=function(a){$(a).addClass("rcpagejumper").on("focus",function(b){var c,d="";for(c=1;c<=ref.env.pagecount;c++)d+="<li>"+c+"</li>";d='<ul class="toolbarmenu">'+d+"</ul>",ref.pagejump||(ref.pagejump=$('<div id="pagejump-selector" class="popupmenu"></div>').appendTo(document.body).on("click","li",function(){ref.busy||$(a).val($(this).text()).change()})),ref.pagejump.data("count")!=c&&ref.pagejump.html(d),ref.pagejump.attr("rel","#"+this.id).data("count",c),ref.show_menu("pagejump-selector",!0,b),$(this).keydown()}).on("keydown keyup click",function(b){var c,d=$("#pagejump-selector"),e=$("ul",d),f=$("li",e),h=(e.height(),parseInt(this.value));if(27!=b.which&&9!=b.which&&13!=b.which&&!d.is(":visible"))return ref.show_menu("pagejump-selector",!0,b);if("keydown"==b.type)if(40==b.which)f.length>h&&(this.value=h+=1);else if(38==b.which)h>1&&f.length>h-1&&(this.value=h-=1);else{if(13==b.which)return $(this).change();if(27==b.which||9==b.which)return $(a).val(ref.env.current_page)}$("li.selected",e).removeClass("selected"),(c=$(f[h-1])).length&&(c.addClass("selected"),$("#pagejump-selector").scrollTop(e.height()/f.length*(h-1)-d.height()/2))}).on("change",function(a){var b=parseInt(this.value);b&&b!=ref.env.current_page&&!ref.busy&&(ref.hide_menu("pagejump-selector"),ref.list_page(b))})},this.update_pagejumper=function(){$("input.rcpagejumper").val(this.env.current_page).prop("disabled",this.env.pagecount<2)},this.check_mailvelope=function(a){void 0!==window.mailvelope?this.mailvelope_load(a):$(window).on("mailvelope",function(){ref.mailvelope_load(a)})},this.mailvelope_load=function(a){this.env.browser_capabilities&&(this.env.browser_capabilities.pgpmime=1);var b=this.env.user_id;mailvelope.getKeyring(b).then(function(b){ref.mailvelope_keyring=b,ref.mailvelope_init(a,b)},function(c){mailvelope.createKeyring(b).then(function(b){ref.mailvelope_keyring=b,ref.mailvelope_init(a,b)},function(a){console.error(a)})})},this.mailvelope_init=function(a,b){if(window.mailvelope)if("show"==a||"preview"==a||"print"==a){if(this.env.is_pgp_content){var c=$(this.env.is_pgp_content).text();ref.mailvelope_display_container(this.env.is_pgp_content,c,b)}else if(this.env.pgp_mime_part){var d=this.display_message(this.get_label("loadingdata"),"loading"),e=this.env.pgp_mime_container;$.ajax({type:"GET",url:this.url("get",{_mbox:this.env.mailbox,_uid:this.env.uid,_part:this.env.pgp_mime_part}),error:function(a,b,c){ref.http_error(a,b,c,d)},success:function(a){ref.mailvelope_display_container(e,a,b,d)}})}}else if("compose"==a){this.env.compose_commands.push("compose-encrypted");var f=$('input[name="_is_html"]').val()>0;if(this.env.pgp_mime_message){var g=this.set_busy(!0,this.get_label("loadingdata"));$.ajax({type:"GET",url:this.url("get",this.env.pgp_mime_message),error:function(a,b,c){ref.http_error(a,b,c,g),ref.enable_command("compose-encrypted",!f)},success:function(a){ref.set_busy(!1,null,g),f&&(ref.command("toggle-editor",{html:!1,noconvert:!0}),$("#"+ref.env.composebody).val("")),ref.compose_encrypted({quotedMail:a}),ref.enable_command("compose-encrypted",!0)}})}else this.enable_command("compose-encrypted",!f);this.addEventListener("actionafter",function(a){a.ret&&"toggle-editor"==a.action&&ref.enable_command("compose-encrypted",!a.props.html)})}},this.compose_encrypted=function(a){var b,c=$("#"+this.env.composebody).parent();ref.mailvelope_editor?(ref.mailvelope_editor=null,ref.compose_skip_unsavedcheck=!1,ref.set_button("compose-encrypted","act"),c.removeClass("mailvelope").find("iframe:not([aria-hidden=true])").remove(),$("#"+ref.env.composebody).show(),$("[name='_pgpmime']").remove(),ref.enable_command("spellcheck","insert-sig","toggle-editor","insert-response","save-response",!0),ref.triggerEvent("compose-encrypted",{active:!1})):(this.spellcheck_state()&&this.editor.spellcheck_stop(),b=a.quotedMail?{quotedMail:a.quotedMail,quotedMailIndent:!1}:{predefinedText:$("#"+this.env.composebody).val()},"reply"==this.env.compose_mode&&(b.quotedMailIndent=!0,b.quotedMailHeader=this.env.compose_reply_header),mailvelope.createEditorContainer("#"+c.attr("id"),ref.mailvelope_keyring,b).then(function(a){ref.mailvelope_editor=a,ref.compose_skip_unsavedcheck=!0,ref.set_button("compose-encrypted","sel"),c.addClass("mailvelope"),$("#"+ref.env.composebody).hide(),ref.enable_command("spellcheck","insert-sig","toggle-editor","insert-response","save-response",!1),ref.triggerEvent("compose-encrypted",{active:!0}),ref.env.attachments&&!$.isEmptyObject(ref.env.attachments)&&(alert(ref.get_label("encryptnoattachments")),$.each(ref.env.attachments,function(a,b){ref.remove_from_attachment_list(a)}))},function(a){console.error(a),console.log(b)}))},this.mailvelope_submit_messageform=function(a,b){var c=[];$.each(["to","cc","bcc"],function(a,b){for(var e,f=$.trim($('[name="_'+b+'"]').val());f.length&&rcube_check_email(f,!0);)e=RegExp.$2,c.push(e),f=f.substr(f.indexOf(e)+e.length+1).replace(/^\s*,\s*/,"")});var d=c.length>0;return ref.mailvelope_keyring.validKeyForAddress(c).then(function(e){var f=[];if($.each(e,function(a,b){!1===b&&(d=!1,f.push(a))}),!d&&f.length)return ref.show_popup_dialog(ref.get_label("nopubkeyfor").replace("$email",f.join(", "))+"<p>"+ref.get_label("searchpubkeyservers")+"</p>",ref.get_label("encryptedsendialog"),[{text:ref.get_label("search"),class:"mainaction",click:function(){var a=$(this);ref.mailvelope_search_pubkeys(f,function(){a.dialog("close")})}},{text:ref.get_label("cancel"),click:function(){$(this).dialog("close")}}]),!1;if(!d)return c.length||(alert(ref.get_label("norecipientwarning")),$("[name='_to']").focus()),!1;var g=[],h=ref.env.identities[$("[name='_from'] option:selected").val()];$.each(ref.env.identities,function(a,b){g.push(b.email)}),ref.mailvelope_keyring.validKeyForAddress(g).then(function(d){if(valid_sender=null,$.each(d,function(a,b){if(!1!==b&&(valid_sender=a,valid_sender==h))return!1}),!valid_sender&&!confirm(ref.get_label("nopubkeyforsender")))return!1;c.push(valid_sender),ref.mailvelope_editor.encrypt(c).then(function(c){var d=ref.gui_objects.messageform,e=$("[name='_pgpmime']",d),f=ref.set_busy(!0,a||b?"savingmessage":"sendingmessage");d.target="savetarget",d._draft.value=a?"1":"",d.action=ref.add_url(d.action,"_unlock",f),d.action=ref.add_url(d.action,"_framed",1),b&&(d.action=ref.add_url(d.action,"_saveonly",1)),e.length||(e=$('<input type="hidden" name="_pgpmime">').appendTo(d)),e.val(c),d.submit()},function(a){console.log(a)})},function(a){console.error(a)})},function(a){console.error(a)}),!1},this.mailvelope_display_container=function(a,b,c,d){mailvelope.createDisplayContainer(a,b,c,{showExternalContent:this.env.safemode}).then(function(){$(a).addClass("mailvelope").children().not("iframe").hide(),ref.hide_message(d),setTimeout(function(){$(window).resize()},10)},function(a){console.error(a),ref.hide_message(d),ref.display_message("Message decryption failed: "+a.message,"error")})},this.mailvelope_search_pubkeys=function(a,b){var c=[],d=new PublicKey,e=ref.display_message(ref.get_label("loading"),"loading");$.each(a,function(a,b){var e=$.Deferred();d.search(b,function(a,c){null!==c?e.resolve([b]):e.resolve([b].concat(a))}),c.push(e)}),$.when.apply($,c).then(function(){var a=[],c=[];$.each(arguments,function(b,d){var e=d.shift();d.length?c=c.concat(d):a.push(e)}),ref.hide_message(e),b(!0),c.length&&ref.mailvelope_key_import_dialog(c),a.length&&ref.display_message(ref.get_label("nopubkeyfor").replace("$email",a.join(", ")),"warning")}).fail(function(){console.error("Pubkey lookup failed with",arguments),ref.hide_message(e),ref.display_message("pubkeysearcherror","error"),b(!1)})},this.mailvelope_key_import_dialog=function(a){var b=$("<div>").addClass("listing mailvelopekeyimport");$.each(a,function(a,c){var d=$("<div>").addClass("key");c.revoked&&d.addClass("revoked"),c.disabled&&d.addClass("disabled"),c.expired&&d.addClass("expired"),d.append($("<label>").addClass("keyid").text(ref.get_label("keyid"))),d.append($("<a>").text(c.keyid.substr(-8).toUpperCase()).attr("href",c.info).attr("target","_blank").attr("tabindex","-1")),d.append($("<label>").addClass("keylen").text(ref.get_label("keylength"))),d.append($("<span>").text(c.keylen)),c.expirationdate&&(d.append($("<label>").addClass("keyexpired").text(ref.get_label("keyexpired"))),d.append($("<span>").text(new Date(1e3*c.expirationdate).toDateString()))),c.revoked&&d.append($("<span>").addClass("keyrevoked").text(ref.get_label("keyrevoked")));var e=$("<ul>").addClass("uids");$.each(c.uids,function(a,b){var c=$("<li>").addClass("uid");b.revoked&&c.addClass("revoked"),b.disabled&&c.addClass("disabled"),b.expired&&c.addClass("expired"),e.append(c.text(b.uid))}),d.append(e),d.append($("<input>").attr("type","button").attr("rel",c.keyid).attr("value",ref.get_label("import")).addClass("button importkey").prop("disabled",c.revoked||c.disabled||c.expired)),b.append(d)}),ref.show_popup_dialog($("<div>").append($("<p>").html(ref.get_label("encryptpubkeysfound"))).append(b),ref.get_label("importpubkeys"),[{text:ref.get_label("close"),click:function(){$(this).dialog("close")}}]),b.on("click","input.button.importkey",function(){var a=$(this),b=a.attr("rel"),c=new PublicKey,d=ref.display_message(ref.get_label("loading"),"loading");c.get(b,function(c,e){if(ref.hide_message(d),e)return void ref.display_message(ref.get_label("keyservererror"),"error");ref.mailvelope_keyring.importPublicKey(c).then(function(c){if("REJECTED"===c);else{var d=b.substr(-8).toUpperCase();a.closest(".key").fadeOut(),ref.display_message(ref.get_label("keyimportsuccess").replace("$key",d),"confirmation")}},function(a){console.log(a)})})})},this.expunge_mailbox=function(a){var b,c={_mbox:a};a==this.env.mailbox&&(b=this.set_busy(!0,"loading"),c._reload=1,this.env.search_request&&(c._search=this.env.search_request)),this.http_post("expunge",c,b)},this.purge_mailbox=function(a){var b,c={_mbox:a};if(!confirm(this.get_label("purgefolderconfirm")))return!1;a==this.env.mailbox&&(b=this.set_busy(!0,"loading"),c._reload=1),this.http_post("purge",c,b)},this.purge_mailbox_test=function(){return this.env.exists&&(this.env.mailbox==this.env.trash_mailbox||this.env.mailbox==this.env.junk_mailbox||this.env.mailbox.startsWith(this.env.trash_mailbox+this.env.delimiter)||this.env.mailbox.startsWith(this.env.junk_mailbox+this.env.delimiter))},this.login_user_keyup=function(a){var b=rcube_event.get_keycode(a),c=$("#rcmloginpwd");return!(13==b&&c.length&&!c.val())||(c.focus(),rcube_event.cancel(a))},this.open_compose_step=function(a){var b=this.url("mail/compose",a);this.env.compose_extwin&&!this.env.extwin?this.open_window(b):(this.redirect(b),this.env.extwin&&window.resizeTo(Math.max(this.env.popup_width,$(window).width()),$(window).height()+24))},this.init_messageform=function(){if(!this.gui_objects.messageform)return!1;var a,b,c,j,d=$("[name='_from']"),e=$("[name='_to']"),f=$("input[name='_subject']"),g=$("[name='_message']").get(0),h="1"==$("input[name='_is_html']").val(),i=["cc","bcc","replyto","followupto"],k=this.opener();k&&"compose"==k.env.action&&(setTimeout(function(){opener.history.length>1?opener.history.back():k.redirect(k.get_task_url("mail"))},100),this.env.opened_extwin=!0),this.env.autocomplete_threads>0&&(j={threads:this.env.autocomplete_threads,sources:this.env.autocomplete_sources}),this.init_address_input_events(e,j);for(a in i)this.init_address_input_events($("[name='_"+i[a]+"']"),j);h||(c=this.env.top_posting&&this.env.compose_mode?0:g.value.length,"select-one"==d.prop("type")&&(this.set_caret_pos(g,0),this.change_identity(d[0])),this.set_caret_pos(g,c),c&&$(g).scrollTop(g.scrollHeight)),this.env.save_localstorage&&this.compose_restore_dialog(0,h),""==e.val()?b=e:""==f.val()?b=f:g&&(b=g),$(b).filter(":visible").focus(),this.env.compose_focus_elem=document.activeElement,this.compose_field_hash(!0),this.auto_save_start()},this.compose_restore_dialog=function(a,b){var c,d,e,f=this.local_storage_get_item("compose.index",[]),g=function(a){++a<f.length&&ref.compose_restore_dialog(a,b)};for(c=a||0;c<f.length;c++)if(d=f[c],e=this.local_storage_get_item("compose."+d,null,!0)){if(e.changed&&d==this.env.compose_id){this.restore_compose_form(d,b);break}if((!this.env.draft_id||!e.draft_id||e.draft_id==this.env.draft_id)&&(!this.env.reply_msgid||e.reply_msgid==this.env.reply_msgid)&&e.changed&&e.session!=this.env.session_id){this.show_popup_dialog(this.get_label("restoresavedcomposedata").replace("$date",new Date(e.changed).toLocaleString()).replace("$subject",e._subject).replace(/\n/g,"<br/>"),this.get_label("restoremessage"),[{text:this.get_label("restore"),class:"mainaction",click:function(){ref.restore_compose_form(d,b),ref.remove_compose_data(d),ref.save_compose_form_local(),$(this).dialog("close")}},{text:this.get_label("delete"),class:"delete",click:function(){ref.remove_compose_data(d),$(this).dialog("close"),g(c)}},{text:this.get_label("ignore"),click:function(){$(this).dialog("close"),g(c)}}]);break}}},this.init_address_input_events=function(a,b){this.env.recipients_delimiter=this.env.recipients_separator+" ",a.keydown(function(a){return ref.ksearch_keydown(a,this,b)}).attr({autocomplete:"off","aria-autocomplete":"list","aria-expanded":"false",role:"combobox"})},this.submit_messageform=function(a,b){var c=this.gui_objects.messageform;if(c){if(!b&&this.env.is_sent)return this.show_popup_dialog(this.get_label("messageissent"),"",[{text:this.get_label("save"),class:"mainaction",click:function(){ref.submit_messageform(!1,!0),$(this).dialog("close")}},{text:this.get_label("cancel"),click:function(){$(this).dialog("close")}}]);if(this.mailvelope_editor)return this.mailvelope_submit_messageform(a,b);var d=this.set_busy(!0,a||b?"savingmessage":"sendingmessage"),e=this.spellcheck_lang(),f=[];$("li",this.gui_objects.attachmentlist).each(function(){f.push(this.id.replace(/^rcmfile/,""))}),$('input[name="_attachments"]',c).val(f.join()),c.target="savetarget",c._draft.value=a?"1":"",c.action=this.add_url(c.action,"_unlock",d),c.action=this.add_url(c.action,"_lang",e),c.action=this.add_url(c.action,"_framed",1),b&&(c.action=this.add_url(c.action,"_saveonly",1)),this.submit_timer=setTimeout(function(){ref.set_busy(!1,null,d),ref.display_message(ref.get_label("requesttimedout"),"error")},1e3*this.env.request_timeout),c.submit()}},this.compose_recipient_select=function(a){var b,c,d=0;for(c=0;c<a.selection.length;c++)b=a.selection[c],this.env.contactdata[b]&&d++;this.enable_command("add-recipient",d)},this.compose_add_recipient=function(a){a||(a=$(this.env.focused_field).filter(":visible"),a=a.length?a.attr("id").replace("_",""):"to");var b=[],c=$("#_"+a),d=this.env.recipients_delimiter;if(this.contact_list&&this.contact_list.selection.length)for(var e,f=0;f<this.contact_list.selection.length;f++)if((e=this.contact_list.selection[f])&&this.env.contactdata[e]&&(b.push(this.env.contactdata[e]),"E"==e.charAt(0)&&this.env.contactdata[e].indexOf("@")<0&&c.length)){var g=e.substr(1);this.group2expand[g]={name:this.env.contactdata[e],input:c.get(0)},this.http_request("group-expand",{_source:this.env.source,_gid:g},!1)}if(b.length&&c.length){var h=c.val(),i=new RegExp(RegExp.escape(d)+"\\s*$");h&&!i.test(h)&&(h+=d+" "),c.val(h+b.join(d+" ")+d+" ").change(),this.triggerEvent("add-recipient",{field:a,recipients:b})}return b.length},this.check_compose_input=function(a){var b=$("[name='_to']"),c=$("[name='_cc']"),d=$("[name='_bcc']"),e=$("[name='_from']"),f=$("[name='_subject']");if("text"==e.prop("type")&&!rcube_check_email(e.val(),!0))return alert(this.get_label("nosenderwarning")),e.focus(),!1;var g=b.val()?b.val():c.val()?c.val():d.val();if(!rcube_check_email(g.replace(/^\s+/,"").replace(/[\s,;]+$/,""),!0))return alert(this.get_label("norecipientwarning")),b.focus(),!1;for(var h in this.env.attachments)if("object"==typeof this.env.attachments[h]&&!this.env.attachments[h].complete)return alert(this.get_label("notuploadedwarning")),!1;if(""==f.val()){var i={},j=$('<div class="prompt">').html('<div class="message">'+this.get_label("nosubjectwarning")+"</div>").appendTo(document.body),k=$("<input>").attr({type:"text",size:30}).val(this.get_label("nosubject")).appendTo(j),l=function(){f.val(k.val()),j.dialog("close"),ref.command(a,{nocheck:!0})};return i[this.get_label("sendmessage")]=function(){l($(this))},i[this.get_label("cancel")]=function(){f.focus(),$(this).dialog("close")},j.dialog({modal:!0,resizable:!1,buttons:i,close:function(a,b){$(this).remove()}}),k.select().keydown(function(a){13==a.which&&l()}),!1}return this.mailvelope_editor||this.editor.get_content()||confirm(this.get_label("nobodywarning"))?(this.editor.save(),!0):(this.editor.focus(),!1)},this.toggle_editor=function(a,b,c){var d=this.editor.toggle(a.html,a.noconvert||!1);return a.mode=a.html?"html":"plain",!d&&c&&(a.mode=a.html?"plain":"html",$(c.target).filter("select").val(a.mode)),d&&$("input[name='_is_html']").val(a.html?1:0),d},this.insert_response=function(a){var b=this.env.textresponses[a]?this.env.textresponses[a].text:null;if(!b)return!1;this.editor.replace(b)},this.save_response=function(){var a={},b=this.editor.get_content({selection:!0,format:"text",nosig:!0}),c='<form class="propform"><div class="prop block"><label>'+this.get_label("responsename")+'</label><input type="text" name="name" id="ffresponsename" size="40" /></div><div class="prop block"><label>'+this.get_label("responsetext")+'</label><textarea name="text" id="ffresponsetext" cols="40" rows="8"></textarea></div></form>';a[this.get_label("save")]=function(a){var b=$("#ffresponsename").val(),c=$("#ffresponsetext").val();if(!c)return $("#ffresponsetext").select(),!1;b||(b=c.substring(0,40));var d=ref.display_message(ref.get_label("savingresponse"),"loading");ref.http_post("settings/responses",{_insert:1,_name:b,_text:c},d),$(this).dialog("close")},a[this.get_label("cancel")]=function(){$(this).dialog("close")},this.show_popup_dialog(c,this.get_label("newresponse"),a,{button_classes:["mainaction"]}),$("#ffresponsetext").val(b),$("#ffresponsename").select()},this.add_response_item=function(a){var b=a.key;if(this.env.textresponses[b]=a,this.gui_objects.responseslist){var c=$("<li>").appendTo(this.gui_objects.responseslist);$("<a>").addClass("insertresponse active").attr("href","#").attr("rel",b).attr("tabindex","0").html(this.quote_html(a.name)).appendTo(c).mousedown(function(a){return rcube_event.cancel(a)}).on("mouseup keypress",function(a){if("mouseup"==a.type||13==rcube_event.get_keycode(a))return ref.command("insert-response",$(this).attr("rel")),$(document.body).trigger("mouseup"),rcube_event.cancel(a)})}},this.edit_responses=function(){},this.delete_response=function(a){if(!a&&this.responses_list){a=this.responses_list.get_selection()[0]}a&&confirm(this.get_label("deleteresponseconfirm"))&&this.http_post("settings/delete-response",{_key:a},!1)},this.spellcheck_state=function(){var a=this.editor.spellcheck_state();return $.each(this.buttons.spellcheck||[],function(b,c){$("#"+c.id)[a?"addClass":"removeClass"]("selected")}),a},this.spellcheck_lang=function(){return this.editor.get_language()},this.spellcheck_lang_set=function(a){this.editor.set_language(a)},this.spellcheck_resume=function(a){this.editor.spellcheck_resume(a)},this.set_draft_id=function(a){if(a&&a!=this.env.draft_id){var b={task:"mail",action:""},c=this.opener(!1,b)||this.opener(!0,b);c&&c.env.mailbox==this.env.drafts_mailbox&&c.command("checkmail"),this.env.draft_id=a,$("input[name='_draft_saveid']").val(a),window.frames.savetarget&&window.frames.savetarget.history&&!this.draft_autosave_submit&&!this.mailvelope_editor&&window.frames.savetarget.history.back(),this.draft_autosave_submit=!1}this.remove_compose_data(this.env.compose_id),this.compose_skip_unsavedcheck=!1},this.auto_save_start=function(){this.env.draft_autosave&&(this.draft_autosave_submit=!1,this.save_timer=setTimeout(function(){ref.draft_autosave_submit=!0,ref.command("savedraft")},1e3*this.env.draft_autosave)),!this.local_save_timer&&window.localStorage&&this.env.save_localstorage&&(this.compose_type_activity=this.compose_type_activity_last=0,$(document).keypress(function(a){ref.compose_type_activity++}),this.local_save_timer=setInterval(function(){ref.compose_type_activity>ref.compose_type_activity_last&&(ref.save_compose_form_local(),ref.compose_type_activity_last=ref.compose_type_activity)},5e3),$(window).on("unload",function(){ref.env.server_error||ref.remove_compose_data(ref.env.compose_id)})),window.onbeforeunload||(window.onbeforeunload=function(){if(!ref.compose_skip_unsavedcheck&&ref.cmp_hash!=ref.compose_field_hash())return ref.get_label("notsentwarning")}),this.busy=!1},this.compose_field_hash=function(a){var b,c,d,e="",f=["to","cc","bcc","subject"];for(b=0;b<f.length;b++)(d=$('[name="_'+f[b]+'"]').val())&&(e+=d+":");if(e+=this.editor.get_content({refresh:!1}),this.env.attachments)for(c in this.env.attachments)e+=c;return this.mailvelope_editor&&(e+=";"+(new Date).getTime()),a&&(this.cmp_hash=e),e},this.save_compose_form_local=function(){if(this.env.save_localstorage){var a={session:this.env.session_id,changed:(new Date).getTime()},c=!0;if(this.editor.save(),this.env.draft_id&&(a.draft_id=this.env.draft_id),this.env.reply_msgid&&(a.reply_msgid=this.env.reply_msgid),$("input, select, textarea",this.gui_objects.messageform).each(function(b,d){switch(d.tagName.toLowerCase()){case"input":if("button"==d.type||"submit"==d.type||"hidden"==d.type&&"_is_html"!=d.name)break;a[d.name]="checkbox"!=d.type||d.checked?$(d).val():"",""!=a[d.name]&&"hidden"!=d.type&&(c=!1);break;case"select":a[d.name]=$("option:checked",d).val();break;default:a[d.name]=$(d).val(),""!=a[d.name]&&(c=!1)}}),!c){var d=this.local_storage_get_item("compose.index",[]),e=this.env.compose_id;$.inArray(e,d)<0&&d.push(e),this.local_storage_set_item("compose."+e,a,!0),this.local_storage_set_item("compose.index",d)}}},this.restore_compose_form=function(a,b){var d=this.local_storage_get_item("compose."+a,!0);d&&"object"==typeof d&&($.each(d,function(a,b){if("_"==a[0]){var c=$("*[name='"+a+"']");c[0]&&"checkbox"==c[0].type?c.prop("checked",""!=b):c.val(b)}}),("1"==d._is_html&&!b||"1"!=d._is_html&&b)&&this.command("toggle-editor",{id:this.env.composebody,html:!b,noconvert:!0}))},this.remove_compose_data=function(a){var b=this.local_storage_get_item("compose.index",[]);$.inArray(a,b)>=0&&(this.local_storage_remove_item("compose."+a),this.local_storage_set_item("compose.index",$.grep(b,function(b,c){return b!=a})))},this.clear_compose_data=function(){var a,b=this.local_storage_get_item("compose.index",[]);for(a=0;a<b.length;a++)this.local_storage_remove_item("compose."+b[a]);this.local_storage_remove_item("compose.index")},this.change_identity=function(a,b){if(!a||!a.options)return!1;b||(b=this.env.show_sig);var c=a.options[a.selectedIndex].value,d=this.env.identity,e=this.env.recipients_separator,f=RegExp.escape(e);return this.env.signatures&&this.env.signatures[c]?(this.enable_command("insert-sig",!0),this.env.compose_commands.push("insert-sig")):this.enable_command("insert-sig",!1),this.env.identities_initialized||(this.env.identities_initialized=!0,this.env.show_sig_later&&(this.env.show_sig=!0),!this.env.opened_extwin)?($.each(["replyto","bcc"],function(){var a,b=this,g=d&&ref.env.identities[d]?ref.env.identities[d][b]:"",h=c&&ref.env.identities[c]?ref.env.identities[c][b]:"",i=$('[name="_'+b+'"]'),j=i.val();g&&j&&(a=new RegExp("\\s*"+RegExp.escape(g)+"\\s*"),j=j.replace(a,"")),a=new RegExp(f+"\\s*"+f,"g"),j=String(j).replace(a,e),a=new RegExp("^[\\s"+f+"]+"),j=j.replace(a,""),h&&-1==j.indexOf(h)&&-1==j.indexOf(h.replace(/"/g,""))&&(j&&(a=new RegExp("["+f+"\\s]+$"),j=j.replace(a,"")+e+" "),j+=h+e+" "),(g||h)&&i.val(j).change()}),this.editor.change_signature(c,b),this.env.identity=c,this.triggerEvent("change_identity"),!0):void 0},this.upload_file=function(a,b,c){if(a){var d=0,e=0;if($("input[type=file]",a).each(function(a,b){var c=b.files?b.files.length:b.value?1:0;if(b.files)for(var a=0;a<c;a++)d+=b.files[a].size;e+=c}),e){if(this.env.max_filesize&&this.env.filesizeerror&&d>this.env.max_filesize)return this.display_message(this.env.filesizeerror,"error"),!1;var f=this.async_upload_form(a,b||"upload",function(a){var b,d="";try{this.contentDocument?b=this.contentDocument:this.contentWindow&&(b=this.contentWindow.document),d=b.childNodes[1].innerHTML}catch(a){}d.match(/add2attachment/)||bw.opera&&(!ref.env.uploadframe||ref.env.uploadframe!=a.data.ts)||(d.match(/display_message/)||ref.display_message(ref.get_label("fileuploaderror"),"error"),ref.remove_from_attachment_list(a.data.ts),c&&ref.set_busy(!1,null,c)),bw.opera&&(ref.env.uploadframe=a.data.ts)}),g="<span>"+this.get_label("uploading"+(e>1?"many":""))+"</span>",h=f.replace(/^rcmupload/,"");return this.add2attachment_list(h,{name:"",html:g,classname:"uploading",frame:f,complete:!1}),this.env.upload_progress_time&&this.upload_progress_start("upload",h),this.gui_objects.attachmentform=a,!0}}},this.add2attachment_list=function(a,b,c){if(c&&this.triggerEvent("fileuploaded",{name:a,attachment:b,id:c}),this.env.attachments||(this.env.attachments={}),c&&this.env.attachments[c]&&delete this.env.attachments[c],this.env.attachments[a]=b,!this.gui_objects.attachmentlist)return!1;!b.complete&&this.env.loadingicon&&(b.html='<img src="'+this.env.loadingicon+'" alt="" class="uploading" />'+b.html),!b.complete&&b.frame&&(b.html='<a title="'+this.get_label("cancel")+'" onclick="return rcmail.cancel_attachment_upload(\''+a+"', '"+b.frame+'\');" href="#cancelupload" class="cancelupload">'+(this.env.cancelicon?'<img src="'+this.env.cancelicon+'" alt="'+this.get_label("cancel")+'" />':this.get_label("cancel"))+"</a>"+b.html);var d,e=$("<li>");e.attr("id",a).addClass(b.classname).html(b.html).on("mouseover",function(){rcube_webmail.long_subject_title_ex(this)}),c&&(d=document.getElementById(c))?e.replaceAll(d):e.appendTo(this.gui_objects.attachmentlist);var f=$(this.gui_objects.attachmentlist).attr("data-tabindex")||"0";return e.find("a").attr("tabindex",f),!0},this.remove_from_attachment_list=function(a){this.env.attachments&&(delete this.env.attachments[a],$("#"+a).remove())},this.remove_attachment=function(a){return a&&this.env.attachments[a]&&this.http_post("remove-attachment",{_id:this.env.compose_id,_file:a}),!0},this.cancel_attachment_upload=function(a,b){return!(!a||!b)&&(this.remove_from_attachment_list(a),$("iframe[name='"+b+"']").remove(),!1)},this.upload_progress_start=function(a,b){setTimeout(function(){ref.http_request(a,{_progress:b})},1e3*this.env.upload_progress_time)},this.upload_progress_update=function(a){var b=$("#"+a.name+" > span");b.length&&a.text&&(b.text(a.text),a.done||this.upload_progress_start(a.action,a.name))},this.add_contact=function(a){return a&&this.http_post("addcontact",{_address:a}),!0},this.qsearch=function(a){if(""!=a){var b,c=this.set_busy(!0,"searching"),d=this.search_params(a),e="compose"==this.env.action&&this.contact_list?"search-contacts":"search";return this.message_list?this.clear_message_list():this.contact_list&&this.list_contacts_clear(),this.env.source&&(d._source=this.env.source),this.env.group&&(d._gid=this.env.group),this.env.current_page=1,b=this.http_request(e,d,c),this.env.qsearch={lock:c,request:b},this.enable_command("set-listmode",this.env.threads&&"base"==(this.env.search_scope||"base")),!0}return!1},this.continue_search=function(a){var b=this.set_busy(!0,"stillsearching");setTimeout(function(){var c=ref.search_params();c._continue=a,ref.env.qsearch={lock:b,request:ref.http_request("search",c,b)}},100)},this.search_params=function(a,b){var c,d={},e=[],f=this.env.search_mods,g=this.env.search_scope||"base",h="all"==g?"*":this.env.mailbox;if(!b&&this.gui_objects.search_filter&&(b=this.gui_objects.search_filter.value),!a&&this.gui_objects.qsearchbox&&(a=this.gui_objects.qsearchbox.value),b&&(d._filter=b),this.gui_objects.search_interval&&(d._interval=$(this.gui_objects.search_interval).val()),a&&(d._q=a,f&&this.message_list&&(f=f[h]||f["*"]),f)){for(c in f)e.push(c);d._headers=e.join(",")}return g&&(d._scope=g),h&&"all"!=g&&(d._mbox=h),d},this.reset_search_filter=function(){this.filter_disabled=!0,this.gui_objects.search_filter&&$(this.gui_objects.search_filter).val("ALL").change(),this.filter_disabled=!1},this.reset_qsearch=function(a){this.gui_objects.qsearchbox&&(this.gui_objects.qsearchbox.value=""),this.gui_objects.search_interval&&$(this.gui_objects.search_interval).val(""),this.env.qsearch&&this.abort_request(this.env.qsearch),a&&(this.env.search_scope="base",this.reset_search_filter()),this.env.qsearch=null,this.env.search_request=null,this.env.search_id=null,this.select_all_mode=!1,this.enable_command("set-listmode",this.env.threads)},this.set_searchscope=function(a){var b=this.env.search_scope;this.env.search_scope=a,a!=b&&this.env.search_request&&(!this.qsearch(this.gui_objects.qsearchbox.value)&&this.env.search_filter&&"ALL"!=this.env.search_filter&&this.filter_mailbox(this.env.search_filter),"all"!=a&&this.select_folder(this.env.mailbox,"",!0))},this.set_searchinterval=function(a){var b=this.env.search_interval;this.env.search_interval=a,a!=b&&this.env.search_request&&(!this.qsearch(this.gui_objects.qsearchbox.value)&&this.env.search_filter&&"ALL"!=this.env.search_filter&&this.filter_mailbox(this.env.search_filter),a&&this.select_folder(this.env.mailbox,"",!0))},this.set_searchmods=function(a){var b=this.env.mailbox;"all"==(this.env.search_scope||"base")&&(b="*"),this.env.search_mods||(this.env.search_mods={}),b&&(this.env.search_mods[b]=a)},this.is_multifolder_listing=function(){return void 0!==this.env.multifolder_listing?this.env.multifolder_listing:this.env.search_request&&"base"!=(this.env.search_scope||"base")},this.sent_successfully=function(a,b,c,d){if(this.display_message(b,a),this.compose_skip_unsavedcheck=!0,this.env.extwin){d||this.lock_form(this.gui_objects.messageform);var e={task:"mail",action:""},f=this.opener(!1,e)||this.opener(!0,e);f&&(f.display_message(b,a),c&&$.inArray(f.env.mailbox,c)>=0&&f.command("checkmail")),d||setTimeout(function(){window.close()},1e3)}else d||setTimeout(function(){ref.list_mailbox()},500);d&&(this.env.is_sent=!0)},this.ksearch_keydown=function(a,b,c){this.ksearch_timer&&clearTimeout(this.ksearch_timer);var d=rcube_event.get_keycode(a),e=rcube_event.get_modifier(a);switch(d){case 38:case 40:if(!this.ksearch_visible())return;var f=38==d?1:0,g=document.getElementById("rcmkSearchItem"+this.ksearch_selected);return g||(g=this.ksearch_pane.__ul.firstChild),g&&this.ksearch_select(f?g.previousSibling:g.nextSibling),rcube_event.cancel(a);case 9:if(e==SHIFT_KEY||!this.ksearch_visible())return void this.ksearch_hide();case 13:return!!this.ksearch_visible()&&(this.insert_recipient(this.ksearch_selected),this.ksearch_hide(),rcube_event.cancel(a));case 27:return void this.ksearch_hide();case 37:case 39:return}return this.ksearch_timer=setTimeout(function(){ref.ksearch_get_results(c)},200),this.ksearch_input=b,!0},this.ksearch_visible=function(){return null!==this.ksearch_selected&&void 0!==this.ksearch_selected&&this.ksearch_value},this.ksearch_select=function(a){this.ksearch_pane&&a&&this.ksearch_pane.find("li.selected").removeClass("selected").removeAttr("aria-selected"),a&&($(a).addClass("selected").attr("aria-selected","true"),this.ksearch_selected=a._rcm_id,$(this.ksearch_input).attr("aria-activedescendant","rcmkSearchItem"+this.ksearch_selected))},this.insert_recipient=function(a){if(null!==a&&this.env.contacts[a]&&this.ksearch_input){var b=this.ksearch_input.value,c=this.get_caret_pos(this.ksearch_input),d=b.lastIndexOf(this.ksearch_value,c),e=!1,f="",g=b.substring(0,d),h=b.substring(d+this.ksearch_value.length,b.length);this.ksearch_destroy(),"object"!=typeof this.env.contacts[a]||"group"!=this.env.contacts[a].type||this.env.contacts[a].email?"object"==typeof this.env.contacts[a]&&this.env.contacts[a].name?(f=this.env.contacts[a].name+this.env.recipients_delimiter,e=!0):"string"==typeof this.env.contacts[a]&&(f=this.env.contacts[a]+this.env.recipients_delimiter,e=!0):(f+=this.env.contacts[a].name+this.env.recipients_delimiter,this.group2expand[this.env.contacts[a].id]=$.extend({input:this.ksearch_input},this.env.contacts[a]),this.http_request("mail/group-expand",{_source:this.env.contacts[a].source,_gid:this.env.contacts[a].id},!1)),this.ksearch_input.value=g+f+h,this.set_caret_pos(this.ksearch_input,d+f.length),e&&(this.triggerEvent("autocomplete_insert",{field:this.ksearch_input,insert:f,data:this.env.contacts[a]}),this.compose_type_activity++)}},this.replace_group_recipients=function(a,b){this.group2expand[a]&&(this.group2expand[a].input.value=this.group2expand[a].input.value.replace(this.group2expand[a].name,b),this.triggerEvent("autocomplete_insert",{field:this.group2expand[a].input,insert:b}),this.group2expand[a]=null,this.compose_type_activity++)},this.ksearch_get_results=function(a){var b=this.ksearch_input?this.ksearch_input.value:null;if(null!==b){this.ksearch_pane&&this.ksearch_pane.is(":visible")&&this.ksearch_pane.hide();var c=this.get_caret_pos(this.ksearch_input),d=b.lastIndexOf(this.env.recipients_separator,c-1),e=b.substring(d+1,c),f=this.env.autocomplete_min_length,g=this.ksearch_data;if((e=$.trim(e))!=this.ksearch_value){if(this.ksearch_destroy(),e.length&&e.length<f)return void(this.ksearch_info||(this.ksearch_info=this.display_message(this.get_label("autocompletechars").replace("$min",f))));var h=this.ksearch_value;if(this.ksearch_value=e,e.length&&(!(h&&h.length&&e.startsWith(h)&&(!g||g.num<=0)&&this.env.contacts)||this.env.contacts.length)){var i=a&&a.sources?a.sources:[""],j=this.multi_thread_http_request({items:i,threads:a&&a.threads?a.threads:1,action:a&&a.action?a.action:"mail/autocomplete",postdata:{_search:e,_source:"%s"},lock:this.display_message(this.get_label("searching"),"loading")});this.ksearch_data={id:j,sources:i.slice(),num:i.length}}}}},this.ksearch_query_results=function(a,b,c){if(this.multi_thread_http_response(a,c),this.ksearch_value&&(!this.ksearch_input||b==this.ksearch_value)){var d,e,f,g,h,i,k=this.ksearch_value,l=this.env.autocomplete_max?this.env.autocomplete_max:15;if(this.ksearch_pane||(g=$("<ul>"),this.is_framed()?this.ksearch_pane=$("<div>").attr("id","rcmKSearchpane").attr("role","listbox").css({position:"absolute","z-index":3e4}).append(g).appendTo(window.parent.document.body):this.ksearch_pane=$("<div>").attr("id","rcmKSearchpane").attr("role","listbox").css({position:"absolute","z-index":3e4}).append(g).appendTo(document.body),this.ksearch_pane.__ul=g[0]),g=this.ksearch_pane.__ul,c&&this.ksearch_pane.data("reqid")==c)l-=g.childNodes.length;else{this.ksearch_pane.data("reqid",c),1,g.innerHTML="",this.env.contacts=[];var m=$(this.ksearch_input).offset();this.ksearch_pane.css({left:m.left+"px",top:m.top+this.ksearch_input.offsetHeight+"px",display:"none"})}if(a&&(f=a.length))for(d=0;d<f&&l>0;d++)h="object"==typeof a[d]?a[d].display||a[d].name:a[d],i="object"==typeof a[d]?a[d].type:"",e=d+this.env.contacts.length,$("<li>").attr("id","rcmkSearchItem"+e).attr("role","option").html('<i class="icon"></i>'+this.quote_html(h.replace(new RegExp("("+RegExp.escape(k)+")","ig"),"##$1%%")).replace(/##([^%]+)%%/g,"<b>$1</b>")).addClass(i||"").appendTo(g).mouseover(function(){ref.ksearch_select(this)}).mouseup(function(){ref.ksearch_click(this)}).get(0)._rcm_id=e,l-=1;g.childNodes.length&&($(this.ksearch_input).attr("aria-haspopup","true").attr("aria-expanded","true").attr("aria-owns","rcmKSearchpane"),this.ksearch_pane.show(),this.env.contacts.length||this.ksearch_select($("li:first",g).get(0))),f&&(this.env.contacts=this.env.contacts.concat(a)),this.ksearch_data.id==c&&this.ksearch_data.num--}},this.ksearch_click=function(a){this.ksearch_input&&this.ksearch_input.focus(),this.insert_recipient(a._rcm_id),this.ksearch_hide()},this.ksearch_blur=function(){this.ksearch_timer&&clearTimeout(this.ksearch_timer),this.ksearch_input=null,this.ksearch_hide()},this.ksearch_hide=function(){this.ksearch_selected=null,this.ksearch_value="",this.ksearch_pane&&this.ksearch_pane.hide(),$(this.ksearch_input).attr("aria-haspopup","false").attr("aria-expanded","false").removeAttr("aria-activedescendant").removeAttr("aria-owns"),this.ksearch_destroy()},this.ksearch_destroy=function(){this.ksearch_data&&this.multi_thread_request_abort(this.ksearch_data.id),this.ksearch_info&&this.hide_message(this.ksearch_info),this.ksearch_msg&&this.hide_message(this.ksearch_msg),this.ksearch_data=null,this.ksearch_info=null,this.ksearch_msg=null},this.contactlist_keypress=function(a){a.key_pressed==a.DELETE_KEY&&this.command("delete")},this.contactlist_select=function(a){this.preview_timer&&clearTimeout(this.preview_timer);var b,c,d,e,f=!1,g=a.selection.length,h=this.env.source?this.env.address_sources[this.env.source]:null;if(this.env.contentframe&&(c=a.get_single_selection())?this.preview_timer=setTimeout(function(){ref.load_contact(c,"show")},200):this.env.contentframe&&this.show_contentframe(!1),g){a.draggable=!1,this.env.selection_sources=[],h&&this.env.selection_sources.push(this.env.source);for(b in a.selection)e=a.data[a.selection[b]],h?f=f||!h.readonly&&!e.readonly:(d=String(a.selection[b]).replace(/^[^-]+-/,""))&&this.env.address_sources[d]&&(f=f||!this.env.address_sources[d].readonly&&!e.readonly,this.env.selection_sources.push(d)),"group"!=e._type&&(a.draggable=!0);this.env.selection_sources=$.unique(this.env.selection_sources)}return this.enable_command("group-remove-selected",this.env.group&&g&&f),this.enable_command("compose",this.env.group||g),this.enable_command("print",1==g),this.enable_command("export-selected","copy",g>0),this.enable_command("edit",c&&f),this.enable_command("delete","move",g&&f),!1},this.list_contacts=function(a,b,c,d){var e,f,g=-1,h={},i=void 0===a&&void 0===b&&void 0===c,j=window;if(a||(a=this.env.source),i&&(b=this.env.group),a!=this.env.source?(c=this.env.current_page=1,this.reset_qsearch()):i||b==this.env.group||(c=this.env.current_page=1),this.env.search_id?f="S"+this.env.search_id:this.env.search_request||(f=b?"G"+a+b:a),this.env.source=a,this.env.group=b,$.each(this.env.address_group_stack,function(a,b){if(ref.env.group==b.id)return g=a,!1}),this.env.address_group_stack=g<0?[]:this.env.address_group_stack.slice(0,g),this.env.group?(d||(d={}),d.id=this.env.group,this.env.address_group_stack.push(d),f="G"+a+this.env.address_group_stack[0].id):this.gui_objects.addresslist_title&&$(this.gui_objects.addresslist_title).text(this.get_label("contacts")),this.env.search_id||this.select_folder(f,"",!0),this.gui_objects.contactslist)return void this.list_contacts_remote(a,b,c);(e=this.get_frame_window(this.env.contentframe))&&(j=e,h._framed=1),b&&(h._gid=b),c&&(h._page=c),a&&(h._source=a),this.env.search_request&&(h._search=this.env.search_request),this.set_busy(!0,"loading"),this.location_href(h,j)},this.list_contacts_remote=function(a,b,c){this.list_contacts_clear();var d={},e=this.set_busy(!0,"loading");a&&(d._source=a),c&&(d._page=c),b&&(d._gid=b),this.env.source=a,this.env.group=b,this.env.search_request&&(d._search=this.env.search_request),this.http_request("mail"==this.env.task?"list-contacts":"list",d,e),"mail"!=this.env.task&&this.update_state({_source:a,_page:c&&c>1?c:null,_gid:b})},this.list_contacts_clear=function(){this.contact_list.data={},this.contact_list.clear(!0),this.show_contentframe(!1),this.enable_command("delete","move","copy","print",!1),this.enable_command("compose",this.env.group)},this.set_group_prop=function(a){if(this.gui_objects.addresslist_title){var b=$(this.gui_objects.addresslist_title).html("");(this.env.address_group_stack.length>1||1==this.env.address_group_stack.length&&this.env.address_group_stack[0].search_request)&&($('<a href="#list">...</a>').attr("title",this.get_label("uponelevel")).addClass("poplink").appendTo(b).click(function(a){return ref.command("popgroup","",this)}),b.append("&nbsp;&raquo;&nbsp;")),b.append($("<span>").text(a?a.name:this.get_label("contacts")))}},this.load_contact=function(a,b,c){var d,e={},f=window,g=this.contact_list?this.contact_list.data[a]:null;if(d=this.get_frame_window(this.env.contentframe))e._framed=1,f=d,this.show_contentframe(!0),a||this.contact_list.clear_selection(),this.enable_command("compose",g&&g.email),this.enable_command("export-selected","print",g&&"group"!=g._type);else if(c)return!1;return!b||!a&&"add"!=b||this.drag_active||(this.env.group&&(e._gid=this.env.group),this.env.search_request&&(e._search=this.env.search_request),e._action=b,e._source=this.env.source,e._cid=a,this.location_href(e,f,!0)),!0},this.group_member_change=function(a,b,c,d){"add"!=a&&(a="del");var e=this.get_label("add"==a?"addingmember":"removingmember"),f=this.display_message(e,"loading"),g={_cid:b,_source:c,_gid:d};this.http_post("group-"+a+"members",g,f)},this.contacts_drag_menu=function(a,b){var c="group"==b.type?b.source:b.id,d=this.env.source;if(!this.env.address_sources[c]||this.env.address_sources[c].readonly)return!0;if(""==d&&1==this.env.selection_sources.length&&(d=this.env.selection_sources[0]),"group"==b.type&&c==d){var e=this.contact_list.get_selection().join(",");return this.group_member_change("add",e,c,b.id),!0}return this.commands.move||rcube_event.get_modifier(a)==SHIFT_KEY?this.drag_menu(a,b):(this.copy_contacts(b),!0)},this.copy_contacts=function(a){var b="group"==a.type?a.source:a.id,c=this.env.source,d=this.env.group?this.env.group:"",e=this.contact_list.get_selection().join(",");if(e&&this.env.address_sources[b]&&!this.env.address_sources[b].readonly)if(""==c&&1==this.env.selection_sources.length&&(c=this.env.selection_sources[0]),"group"==a.type){if(b==c)return;var f=this.display_message(this.get_label("copyingcontact"),"loading"),g={_cid:e,_source:this.env.source,_to:b,_togid:a.id,_gid:d};this.http_post("copy",g,f)}else if(a.id!=c){var f=this.display_message(this.get_label("copyingcontact"),"loading"),g={_cid:e,_source:this.env.source,_to:a.id,_gid:d};this.http_post("copy",g,f)}},this.move_contacts=function(a){var b="group"==a.type?a.source:a.id,c=this.env.source;this.env.group&&this.env.group;if(this.env.address_sources[b]&&!this.env.address_sources[b].readonly)if(""==c&&1==this.env.selection_sources.length&&(c=this.env.selection_sources[0]),"group"==a.type){if(b==c)return;this._with_selected_contacts("move",{_to:b,_togid:a.id})}else a.id!=c&&this._with_selected_contacts("move",{_to:a.id})},this.delete_contacts=function(){if(this.env.source&&this.env.address_sources[this.env.source].undelete||confirm(this.get_label("deletecontactconfirm")))return this._with_selected_contacts("delete")},this._with_selected_contacts=function(a,b){var c=this.contact_list?this.contact_list.get_selection():[];if(c.length||this.env.cid){var d,e=[],f="delete"==a?"contactdeleting":"movingcontact",g=this.display_message(this.get_label(f),"loading");if(this.env.cid)e.push(this.env.cid);else{for(d=0;d<c.length;d++)id=c[d],e.push(id),this.contact_list.remove_row(id,d==c.length-1);1==c.length&&this.show_contentframe(!1)}return b||(b={}),b._source=this.env.source,b._from=this.env.action,b._cid=e.join(","),this.env.group&&(b._gid=this.env.group),this.env.search_request&&(b._search=this.env.search_request),this.http_post(a,b,g),!0}},this.update_contact_row=function(a,b,c,d,e){var f=this.contact_list;a=this.html_identifier(a),f.rows[a]||(a=a+"-"+d,c&&(c=c+"-"+d)),f.update_row(a,b,c,!0),f.data[a]=e},this.add_contact_row=function(a,b,c,d){if(!this.gui_objects.contactslist)return!1;var e,f,g=this.contact_list,h={cols:[]};h.id="rcmrow"+this.html_identifier(a),h.className="contact "+(c||""),g.in_selection(a)&&(h.className+=" selected");for(e in b)f={},f.className=String(e).toLowerCase(),f.innerHTML=b[e],h.cols.push(f);g.data[a]=d,g.insert_row(h),this.enable_command("export",g.rowcount>0)},this.init_contact_form=function(){var a;if(this.env.coltypes){this.set_photo_actions($("#ff_photo").val());for(a in this.env.coltypes)this.init_edit_field(a,null)}$(".contactfieldgroup .row a.deletebutton").click(function(){return ref.delete_edit_field(this),!1}),$("select.addfieldmenu").change(function(){ref.insert_edit_field($(this).val(),$(this).attr("rel"),this),this.selectedIndex=0}),$.datepicker&&this.env.date_format&&($.datepicker.setDefaults({dateFormat:this.env.date_format,changeMonth:!0,changeYear:!0,yearRange:"-120:+10",showOtherMonths:!0,selectOtherMonths:!0}),$("input.datepicker").datepicker()),"search"==this.env.action&&$(this.gui_objects.editform).append($('<input type="submit">').hide()).submit(function(){return $("input.mainaction").click(),!1})},this.group_create=function(){var a=$("<input>").attr("type","text"),b=$("<label>").text(this.get_label("namex")).append(a);this.show_popup_dialog(b,this.get_label("newgroup"),[{text:this.get_label("save"),class:"mainaction",click:function(){var b;(b=a.val())&&ref.http_post("group-create",{_source:ref.env.source,_name:b},ref.set_busy(!0,"loading")),$(this).dialog("close")}}])},this.group_rename=function(){if(this.env.group){var a=this.env.contactgroups["G"+this.env.source+this.env.group].name,b=$("<input>").attr("type","text").val(a),c=$("<label>").text(this.get_label("namex")).append(b);this.show_popup_dialog(c,this.get_label("grouprename"),[{text:this.get_label("save"),class:"mainaction",click:function(){var c;(c=b.val())&&c!=a&&ref.http_post("group-rename",{_source:ref.env.source,_gid:ref.env.group,_name:c},ref.set_busy(!0,"loading")),$(this).dialog("close")}}],{open:function(){b.select()}})}},this.group_delete=function(){if(this.env.group&&confirm(this.get_label("deletegroupconfirm"))){var a=this.set_busy(!0,"groupdeleting");this.http_post("group-delete",{_source:this.env.source,_gid:this.env.group},a)}},this.remove_group_item=function(a){var b="G"+a.source+a.id;this.treelist.remove(b)&&(this.triggerEvent("group_delete",{source:a.source,id:a.id}),delete this.env.contactfolders[b],delete this.env.contactgroups[b]),this.list_contacts(a.source,0)},this.group_remove_selected=function(){this.http_post("group-delmembers",{_cid:this.contact_list.selection,_source:this.env.source,_gid:this.env.group})},this.remove_group_contacts=function(a){if(void 0!==this.env.group&&this.env.group===a.gid){var b,c=this.contact_list.get_selection();for(b=0;b<c.length;b++)id=c[b],this.contact_list.remove_row(id,b==c.length-1)}},this.insert_contact_group=function(a){a.type="group";var b="G"+a.source+a.id,c=$("<a>").attr("href","#").attr("rel",a.source+":"+a.id).click(function(){return ref.command("listgroup",a,this)}).html(a.name);this.env.contactfolders[b]=this.env.contactgroups[b]=a,this.treelist.insert({id:b,html:c,classes:["contactgroup"]},a.source,"contactgroup"),this.triggerEvent("group_insert",{id:a.id,source:a.source,name:a.name,li:this.treelist.get_item(b)})},this.update_contact_group=function(a){var b="G"+a.source+a.id,c={};if(a.newid){var d="G"+a.source+a.newid,e=$.extend({},a);this.env.contactfolders[d]=this.env.contactfolders[b],this.env.contactfolders[d].id=a.newid,this.env.group=a.newid,delete this.env.contactfolders[b],delete this.env.contactgroups[b],e.id=a.newid,e.type="group",c.id=d,c.html=$("<a>").attr("href","#").attr("rel",a.source+":"+a.newid).click(function(){return ref.command("listgroup",e,this)}).html(a.name)}else $(this.treelist.get_item(b)).children().first().html(a.name),this.env.contactfolders[b].name=this.env.contactgroups[b].name=a.name,this.set_group_prop(a);this.treelist.update(b,c,!0),this.triggerEvent("group_update",{id:a.id,source:a.source,name:a.name,li:this.treelist.get_item(b),newid:a.newid})},this.update_group_commands=function(){var a=""!=this.env.source?this.env.address_sources[this.env.source]:null,b=a&&a.groups&&!a.readonly;this.enable_command("group-create",b),this.enable_command("group-rename","group-delete",b&&this.env.group)},this.init_edit_field=function(a,b){var c=this.env.coltypes[a].label;b||(b=$(".ff_"+a)),c&&b.placeholder(c)},this.insert_edit_field=function(a,b,c){var d=$("#ff_"+a);if(d.length)d.show().focus(),$(c).children('option[value="'+a+'"]').prop("disabled",!0);else{var f=($(".ff_"+a),$("#contactsection"+b+" .contactcontroller"+a));if(!f.length){var g=$("#contactsection"+b),h=$(".contactfieldgroup",g).last();f=$("<fieldset>").addClass("contactfieldgroup contactcontroller"+a),h.length?f.insertAfter(h):g.prepend(f)}if(f.length&&"FIELDSET"==f.get(0).nodeName){var i,j=this.env.coltypes[a],k="ff_"+a+(j.count||0),l=$("<div>").addClass("row"),m=$("<div>").addClass("contactfieldcontent data"),n=$("<div>").addClass("contactfieldlabel label");j.subtypes_select?n.html(j.subtypes_select):n.html('<label for="'+k+'">'+j.label+"</label>");var o=1!=j.limit?"[]":"";if("text"==j.type||"date"==j.type)i=$("<input>").addClass("ff_"+a).attr({type:"text",name:"_"+a+o,size:j.size,id:k}).appendTo(m),this.init_edit_field(a,i),"date"==j.type&&$.datepicker&&i.datepicker();else if("textarea"==j.type)i=$("<textarea>").addClass("ff_"+a).attr({name:"_"+a+o,cols:j.size,rows:j.rows,id:k}).appendTo(m),this.init_edit_field(a,i);else if("composite"==j.type){var p,q,r,s,t,u=[],v=[];if(t=this.env[a+"_template"])for(p=0;p<t.length;p++)u.push(t[p][1]),v.push(t[p][2]);else for(q in j.childs)u.push(q);for(p=0;p<u.length;p++)q=u[p],r=j.childs[q],i=$("<input>").addClass("ff_"+q).attr({type:"text",name:"_"+q+o,size:r.size}).appendTo(m),m.append(v[p]||" "),this.init_edit_field(q,i),s||(s=i);i=s}else if("select"==j.type){i=$("<select>").addClass("ff_"+a).attr({name:"_"+a+o,id:k}).appendTo(m);var w=i.attr("options");w[w.length]=new Option("---",""),j.options&&$.each(j.options,function(a,b){w[w.length]=new Option(b,a)})}if(i){$('<a href="#del"></a>').addClass("contactfieldbutton deletebutton").attr({title:this.get_label("delete"),rel:a}).html(this.env.delbutton).click(function(){return ref.delete_edit_field(this),!1}).appendTo(m);l.append(n).append(m).appendTo(f.show()),i.first().focus(),j.count||(j.count=0),++j.count==j.limit&&j.limit&&$(c).children('option[value="'+a+'"]').prop("disabled",!0)}}}},this.delete_edit_field=function(a){var b=$(a).attr("rel"),c=this.env.coltypes[b],d=$(a).parents("fieldset.contactfieldgroup"),e=d.parent().find("select.addfieldmenu");if(--c.count<=0&&c.visible?$(a).parent().children("input").val("").blur():($(a).parents("div.row").remove(),d.children("div.row").length||d.hide()),e.length){var f=e.children('option[value="'+b+'"]');f.length?f.prop("disabled",!1):f=$("<option>").attr("value",b).html(c.label).appendTo(e),e.show()}},this.upload_contact_photo=function(a){a&&a.elements._photo.value&&(this.async_upload_form(a,"upload-photo",function(a){ref.set_busy(!1,null,ref.file_upload_id)}),this.file_upload_id=this.set_busy(!0,"uploading"))},this.replace_contact_photo=function(a){var b="-del-"==a?this.env.photo_placeholder:this.env.comm_path+"&_action=photo&_source="+this.env.source+"&_cid="+(this.env.cid||0)+"&_photo="+a;this.set_photo_actions(a),$(this.gui_objects.contactphoto).children("img").attr("src",b)},this.photo_upload_end=function(){this.set_busy(!1,null,this.file_upload_id),delete this.file_upload_id},this.set_photo_actions=function(a){var b,c=this.buttons["upload-photo"];for(b=0;c&&b<c.length;b++)$("a#"+c[b].id).html(this.get_label("-del-"==a?"addphoto":"replacephoto"));$("#ff_photo").val(a),this.enable_command("upload-photo",!!this.env.coltypes.photo),this.enable_command("delete-photo",this.env.coltypes.photo&&"-del-"!=a)},this.advanced_search=function(){var a,b={_form:1,_action:"search"},c=window;return(a=this.get_frame_window(this.env.contentframe))&&(b._framed=1,c=a,this.contact_list.clear_selection()),this.location_href(b,c,!0),!0},this.unselect_directory=function(){this.select_folder(""),this.enable_command("search-delete",!1)},this.insert_saved_search=function(a,b){var c="S"+b,d=$("<a>").attr("href","#").attr("rel",b).click(function(){return ref.command("listsearch",b,this)}).html(a),e={name:a,id:b};this.savedsearchlist.insert({id:c,html:d,classes:["contactsearch"]},null,"contactsearch"),this.select_folder(c,"",!0),this.enable_command("search-delete",!0),this.env.search_id=b,this.triggerEvent("abook_search_insert",e)},this.search_create=function(){var a=$("<input>").attr("type","text"),b=$("<label>").text(this.get_label("namex")).append(a);this.show_popup_dialog(b,this.get_label("searchsave"),[{text:this.get_label("save"),class:"mainaction",click:function(){var b;(b=a.val())&&ref.http_post("search-create",{_search:ref.env.search_request,_name:b},ref.set_busy(!0,"loading")),$(this).dialog("close")}}])},this.search_delete=function(){if(this.env.search_request){var a=this.set_busy(!0,"savedsearchdeleting");this.http_post("search-delete",{_sid:this.env.search_id},a)}},this.remove_search_item=function(a){var b,c="S"+a;this.savedsearchlist.remove(c)&&this.triggerEvent("search_delete",{id:a,li:b}),this.env.search_id=null,this.env.search_request=null,this.list_contacts_clear(),this.reset_qsearch(),this.enable_command("search-delete","search-create",!1)},this.listsearch=function(a){var b=this.set_busy(!0,"searching");this.contact_list&&this.list_contacts_clear(),this.reset_qsearch(),this.savedsearchlist?(this.treelist.select(""),this.savedsearchlist.select("S"+a)):this.select_folder("S"+a,"",!0),this.env.current_page=1,this.http_request("search",{_sid:a},b)},this.section_select=function(a){var b,c=a.get_single_selection(),d=window,e={_action:"edit-prefs",_section:c};return c&&((b=this.get_frame_window(this.env.contentframe))&&(e._framed=1,d=b),this.location_href(e,d,!0)),!0},this.identity_select=function(a){var b;(b=a.get_single_selection())&&(this.enable_command("delete",a.rowcount>1&&this.env.identities_level<2),this.load_identity(b,"edit-identity"))},this.load_identity=function(a,b){if("edit-identity"==b&&(!a||a==this.env.iid))return!1;var c,d=window,e={_action:b,_iid:a};return(c=this.get_frame_window(this.env.contentframe))&&(e._framed=1,d=c),(a||"add-identity"==b)&&this.location_href(e,d,!0),!0},this.delete_identity=function(a){var b=this.identity_list.get_selection();(b.length||this.env.iid)&&(a||(a=this.env.iid?this.env.iid:b[0]),a&&confirm(this.get_label("deleteidentityconfirm"))&&this.http_post("settings/delete-identity",{_iid:a},!0))},this.update_identity_row=function(a,b,c){var d=this.identity_list,e=this.html_identifier(a);c?(d.insert_row({id:"rcmrow"+e,cols:[{className:"mail",innerHTML:b}]}),d.select(e)):d.update_row(e,[b])},this.update_response_row=function(a,b){var c=this.responses_list;c&&b?c.update_row(b,[a.name],a.key,!0):c&&(c.insert_row({id:"rcmrow"+a.key,cols:[{className:"name",innerHTML:a.name}]}),c.select(a.key))},this.remove_response=function(a){var b;this.env.textresponses&&delete this.env.textresponses[a],this.responses_list&&(this.responses_list.remove_row(a),this.env.contentframe&&(b=this.get_frame_window(this.env.contentframe))&&(b.location.href=this.env.blankpage)),this.enable_command("delete",!1)},this.remove_identity=function(a){var b,c=this.identity_list,d=this.html_identifier(a);c&&a&&(c.remove_row(d),this.env.contentframe&&(b=this.get_frame_window(this.env.contentframe))&&(b.location.href=this.env.blankpage)),this.enable_command("delete",!1)},this.init_subscription_list=function(){var a=RegExp.escape(this.env.delimiter);this.last_sub_rx=RegExp("["+a+"]?[^"+a+"]+$"),this.subscription_list=new rcube_treelist_widget(this.gui_objects.subscriptionlist,{selectable:!0,tabexit:!1,parent_focus:!0,id_prefix:"rcmli",id_encode:this.html_identifier_encode,id_decode:this.html_identifier_decode,searchbox:"#foldersearch"}),this.subscription_list.addEventListener("select",function(a){ref.subscription_select(a.id)}).addEventListener("collapse",function(a){ref.folder_collapsed(a)}).addEventListener("expand",function(a){ref.folder_collapsed(a)}).addEventListener("search",function(a){a.query&&ref.subscription_select()}).draggable({cancel:"li.mailbox.root,input,div.treetoggle"}).droppable({accept:function(a){if(!$(a).is(".mailbox"))return!1;var b=ref.folder_id2name($(a).attr("id")),c=ref.folder_id2name(this.id),d=ref.env.subscriptionrows[b];ref.env.subscriptionrows[c];return d&&!d[2]&&c!=b.replace(ref.last_sub_rx,"")&&!c.startsWith(b+ref.env.delimiter)},drop:function(a,b){var c=ref.folder_id2name(b.draggable.attr("id")),d=ref.folder_id2name(this.id);ref.subscription_move_folder(c,d)}})},this.folder_id2name=function(a){return a?ref.html_identifier_decode(a.replace(/^rcmli/,"")):null},this.subscription_select=function(a){var b;a&&"*"!=a&&(b=this.env.subscriptionrows[a])?(this.env.mailbox=a,this.show_folder(a),this.enable_command("delete-folder",!b[2])):(this.env.mailbox=null,this.show_contentframe(!1),this.enable_command("delete-folder","purge",!1))},this.subscription_move_folder=function(a,b){if(a&&null!==b&&a!=b&&b!=a.replace(this.last_sub_rx,"")){var c=a.split(this.env.delimiter),d=c.pop(),e=""===b||"*"===b?d:b+this.env.delimiter+d;e!=a&&this.http_post("rename-folder",{_folder_oldname:a,_folder_newname:e},this.set_busy(!0,"foldermoving"))}},this.create_folder=function(){this.show_folder("",this.env.mailbox)},this.delete_folder=function(a){a||(a=this.env.mailbox),a&&confirm(this.get_label("deletefolderconfirm"))&&this.http_post("delete-folder",{_mbox:a},this.set_busy(!0,"folderdeleting"))},this.add_folder_row=function(a,b,c,d,e,f,g,h){if(!this.gui_objects.subscriptionlist)return!1;this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search()),this.subscription_list.draggable("destroy").droppable("destroy");var i,j,k,l,m,n,o,p,q="",r=[],s=[],t=[],u=$(this.gui_objects.subscriptionlist);if(i=g||$($("li",u).get(1)).clone(!0),!i.length)return this.goto_url("folders"),!1;i.attr({id:"rcmli"+this.html_identifier_encode(a),class:f}),g&&g.length||($("ul,div.treetoggle",i).remove(),i.removeData("filtered")),$("a:first",i).text(c),$('input[name="_subscribed[]"]:first',i).val(a).prop({checked:!!e,disabled:!!d}),this.env.subscriptionrows[a]=[b,c,!1],$.each(this.env.subscriptionrows,function(a,b){b[3]=a,r.push(b)});try{n=new Intl.Collator(this.env.locale.replace("_","-"))}catch(a){}r.sort(function(a,b){var c,d,e,f=a[0].split(ref.env.delimiter),g=b[0].split(ref.env.delimiter),h=f.length;for(c=0;c<h;c++){if(d=f[c],e=g[c],d!==e)return void 0===e?1:n?n.compare(d,e):d<e?-1:1;if(c==h-1)return-1}});for(j in r)if(p=r[j][3],r[j][2]){if((l=p+this.env.delimiter)==this.env.prefix_ns)continue;t.push(p),k=l}else k&&p.startsWith(k)?t.push(p):(s.push(p),k=null);for(j=0;j<t.length;j++)a.startsWith(t[j]+this.env.delimiter)&&(m=t[j]);for(j=0;!m&&j<s.length;j++)j&&s[j]==a&&(m=s[j-1]);if(m&&(j=this.subscription_list.get_item(m,!0)))if((o=a.lastIndexOf(this.env.delimiter))&&(q=a.substring(0,o),q=this.subscription_list.get_item(q,!0),$("div.treetoggle",q).length||$("<div>&nbsp;</div>").addClass("treetoggle collapsed").appendTo(q),$("ul",q).length||$("<ul>").css("display","none").appendTo(q)),q&&j==q)$("ul:first",q).append(i);else{for(;(p=$(j).parent().parent().get(0))&&(!q||p!=q)&&$(p).is("li.mailbox");)j=p;$(j).after(i)}else u.append(i);return $.extend(this.env.subscriptionrows,h||{}),this.subscription_list.reset(!0),this.subscription_select(),q&&this.subscription_list.expand(this.folder_id2name(q.id)),i=i.show().get(0),i.scrollIntoView&&i.scrollIntoView(),i},this.replace_folder_row=function(a,b,c,d,e,f){if(!this.gui_objects.subscriptionlist)return!!this.is_framed()&&window.parent.rcmail.replace_folder_row(a,b,c,d,e,f);this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search());var g={},h=this.subscription_list.get_item(a,!0),i=$(h).parent(),j=this.env.subscriptionrows[a],k=a.length,l=j[0].length,m=$('input[name="_subscribed[]"]:first',h).prop("checked");if(a==b)return void $(h).attr("class",f||"");$("li",h).each(function(){var a=ref.folder_id2name(this.id),d=ref.env.subscriptionrows[a],e=b+a.slice(k);this.id="rcmli"+ref.html_identifier_encode(e),$('input[name="_subscribed[]"]:first',this).val(e),d[0]=c+d[0].slice(l),g[e]=d,delete ref.env.subscriptionrows[a]}),h=$(h).detach(),delete this.env.subscriptionrows[a],i.get(0)==this.gui_objects.subscriptionlist||$("li",i).length||$("ul,div.treetoggle",i.parent()).remove(),this.add_folder_row(b,c,d,e,m,f,h,g)},this.remove_folder_row=function(a){this.subscription_list.is_search()&&(this.subscription_select(),this.subscription_list.reset_search());var b=[],c=this.subscription_list.get_item(a,!0);$("li",c).each(function(){b.push(ref.folder_id2name(this.id))}),this.subscription_list.remove(a),b.push(a),$.each(b,function(a,b){delete ref.env.subscriptionrows[b]})},this.subscribe=function(a){if(a){var b=this.display_message(this.get_label("foldersubscribing"),"loading");this.http_post("subscribe",{_mbox:a},b)}},this.unsubscribe=function(a){if(a){var b=this.display_message(this.get_label("folderunsubscribing"),"loading");this.http_post("unsubscribe",{_mbox:a},b)}},this.show_folder=function(a,b,c){var d,e=window,f="&_action=edit-folder&_mbox="+urlencode(a);b&&(f+="&_path="+urlencode(b)),(d=this.get_frame_window(this.env.contentframe))&&(e=d,f+="&_framed=1"),String(e.location.href).indexOf(f)>=0&&!c?this.show_contentframe(!0):this.location_href(this.env.comm_path+f,e,!0)},this.disable_subscription=function(a){var b=this.subscription_list.get_item(a,!0);b&&$('input[name="_subscribed[]"]:first',b).prop("disabled",!0)},this.reset_subscription=function(a,b){var c=this.subscription_list.get_item(a,!0);c&&$('input[name="_subscribed[]"]:first',c).prop("checked",b)},this.folder_size=function(a){var b=this.set_busy(!0,"loading");this.http_post("folder-size",{_mbox:a},b)},this.folder_size_update=function(a){$("#folder-size").replaceWith(a)},this.folder_filter=function(a){this.subscription_list.reset_search(),this.subscription_list.container.children("li").each(function(){var b,c=ref.folder_id2name(this.id);if("---"==a);else if(a){if(c!==a)return void $(this).data("filtered",!0).hide()}else for(b in ref.env.ns_roots)if(c===ref.env.ns_roots[b])return void $(this).data("filtered",!0).hide();$(this).removeData("filtered").show()})};var init_button=function(a,b){var c=document.getElementById(b.id);if(c){var d=!1;"image"==b.type&&(c=c.parentNode,d=!0),c._command=a,c._id=b.id,b.sel&&(c.onmousedown=function(a){return ref.button_sel(this._command,this._id)},c.onmouseup=function(a){return ref.button_out(this._command,this._id)},d&&((new Image).src=b.sel)),b.over&&(c.onmouseover=function(a){return ref.button_over(this._command,this._id)},c.onmouseout=function(a){return ref.button_out(this._command,this._id)},d&&((new Image).src=b.over))}};this.init_buttons=function(){for(var a in this.buttons)if("string"==typeof a)for(var b=0;b<this.buttons[a].length;b++)init_button(a,this.buttons[a][b])},this.set_button=function(a,b){var c,d,e,f,g=this.buttons[a],h=g?g.length:0;for(c=0;c<h;c++)d=g[c],(e=document.getElementById(d.id))&&d.status!==b&&("image"!=d.type||d.status?d.status||(d.pas=String(e.className)):(d.pas=e._original_src?e._original_src:e.src,e.runtimeStyle&&e.runtimeStyle.filter&&e.runtimeStyle.filter.match(/src=['"]([^'"]+)['"]/)&&(d.pas=RegExp.$1)),d.status=b,"image"==d.type&&d[b]?e.src=d[b]:void 0!==d[b]&&(e.className=d[b]),"input"==d.type?e.disabled="pas"==b:"uibutton"==d.type?(d.status=b,$(e).button("option","disabled","pas"==b)):(f=$(e),f.attr("tabindex","pas"==b||"sel"==b?"-1":f.attr("data-tabindex")||"0").attr("aria-disabled","pas"==b||"sel"==b?"true":"false")))},this.set_alttext=function(a,b){var c,d,e,f,g=this.buttons[a],h=g?g.length:0;for(c=0;c<h;c++)d=g[c],e=document.getElementById(d.id),"image"==d.type&&e?(e.setAttribute("alt",this.get_label(b)),(f=e.parentNode)&&"a"==f.tagName.toLowerCase()&&f.setAttribute("title",this.get_label(b))):e&&e.setAttribute("title",this.get_label(b))},this.button_over=function(a,b){this.button_event(a,b,"over")},this.button_sel=function(a,b){this.button_event(a,b,"sel")},this.button_out=function(a,b){this.button_event(a,b,"act")},this.button_event=function(a,b,c){var d,e,f,g=this.buttons[a],h=g?g.length:0;for(d=0;d<h;d++)e=g[d],e.id==b&&"act"==e.status&&(e[c]&&(f=document.getElementById(e.id))&&(f["image"==e.type?"src":"className"]=e[c]),"sel"==c&&(this.buttons_sel[b]=a))},this.set_pagetitle=function(a){a&&document.title&&(document.title=a)},this.display_message=function(a,b,c,d){if(this.is_framed())return parent.rcmail.display_message(a,b,c);if(!this.gui_objects.message)return"loading"!=b&&(this.pending_message=[a,b,c,d]),1;b||(b="notice"),d||(d=this.html_identifier(a));var e=new Date,f=b+e.getTime();if(!c)switch(b){case"error":case"warning":c=2*this.message_time;break;case"uploading":c=0;break;default:c=this.message_time}if("loading"==b&&(d="loading",c=1e3*this.env.request_timeout,a||(a=this.get_label("loading"))),this.messages[d])return this.messages[d].obj&&this.messages[d].obj.html(a),"loading"==b&&this.messages[d].labels.push({id:f,msg:a}),this.messages[d].elements.push(f),setTimeout(function(){ref.hide_message(f,"loading"==b)},c),f;var g=$("<div>").addClass(b).html(a).data("key",d);$(this.gui_objects.message).append(g).show();return this.messages[d]={obj:g,elements:[f]},"loading"==b?this.messages[d].labels=[{id:f,msg:a}]:"uploading"!=b&&g.click(function(){return ref.hide_message(g)}).attr("role","alert"),this.triggerEvent("message",{message:a,type:b,timeout:c,object:g}),c>0&&setTimeout(function(){ref.hide_message(f,"loading"!=b)},c),f},this.hide_message=function(a,b){if(this.is_framed())return parent.rcmail.hide_message(a,b);if(this.gui_objects.message){var c,d,e,f,g=this.messages;if("object"==typeof a)f=$(a),c=f.data("key"),this.hide_message_object(f,b),g[c]&&delete g[c];else for(c in g)for(d in g[c].elements)if(g[c]&&g[c].elements[d]==a)if(g[c].elements.splice(d,1),g[c].elements.length){if("loading"==c)for(e in g[c].labels)g[c].labels[e].id==a?delete g[c].labels[e]:(f=g[c].labels[e].msg,g[c].obj.html(f))}else this.hide_message_object(g[c].obj,b),delete g[c]}},this.hide_message_object=function(a,b){b?a.fadeOut(600,function(){$(this).remove()}):a.hide().remove()},this.clear_messages=function(){if(this.is_framed())return parent.rcmail.clear_messages();var a,b,c=this.messages;for(a in c)for(b in c[a].elements)c[a].obj&&this.hide_message_object(c[a].obj);this.messages={}},this.display_progress=function(a){if(a&&a.name){var b=this.messages["progress"+a.name];if(a.label||(a.label=this.get_label("uploadingmany")),!b)return void((!a.percent||a.percent<100)&&this.display_message(a.label,"uploading",0,"progress"+a.name));if(!a.total||a.percent>=100)return void this.hide_message(b.obj);a.text&&(a.label+=" "+a.text),b.obj.text(a.label)}},this.show_popup_dialog=function(a,b,c,d){if(this.is_framed())return parent.rcmail.show_popup_dialog(a,b,c,d);var e=$('<div class="popup">');"object"==typeof a?e.append(a):e.html(a),d=$.extend({title:b,buttons:c,modal:!0,resizable:!0,width:500,close:function(a,b){$(this).remove()}},d||{}),e.dialog(d);var f=$(window),g=f.width(),h=f.height(),i=e.width(),j=e.height();return e.dialog("option",{height:Math.min(h-40,j+75+(c?50:0)),width:Math.min(g-20,i+36)}),$.each(d.button_classes||[],function(a,b){b&&$($(".ui-dialog-buttonpane button.ui-button",e.parent()).get(a)).addClass(b)}),e},this.set_page_buttons=function(){this.enable_command("nextpage","lastpage",this.env.pagecount>this.env.current_page),this.enable_command("previouspage","firstpage",this.env.current_page>1),this.update_pagejumper()},this.select_folder=function(a,b,c){this.savedsearchlist&&this.savedsearchlist.select(""),this.treelist?this.treelist.select(a):this.gui_objects.folderlist&&($("li.selected",this.gui_objects.folderlist).removeClass("selected"),$(this.get_folder_li(a,b,c)).addClass("selected"),this.triggerEvent("selectfolder",{folder:a,prefix:b}))},this.mark_folder=function(a,b,c,d){$(this.get_folder_li(a,c,d)).addClass(b),this.triggerEvent("markfolder",{folder:a,mark:b,status:!0})},this.unmark_folder=function(a,b,c,d){$(this.get_folder_li(a,c,d)).removeClass(b),this.triggerEvent("markfolder",{folder:a,mark:b,status:!1})},this.get_folder_li=function(a,b,c){if(b||(b="rcmli"),this.gui_objects.folderlist)return a=this.html_identifier(a,c),document.getElementById(b+a)},this.set_message_coltypes=function(a,b,d){var b,g,h,i,j,k,e=this.message_list,f=e?e.thead:null;if(this.env.listcols=a,this.env.coltypes||(this.env.coltypes={}),f){if(b){for(f.innerHTML="",k=document.createElement("tr"),c=0,j=b.length;c<j;c++)g=document.createElement("th"),g.innerHTML=b[c].html||"",b[c].id&&(g.id=b[c].id),b[c].className&&(g.className=b[c].className),k.appendChild(g);f.appendChild(k)}for(i=0,j=this.env.listcols.length;i<j;i++)h=this.env.listcols[i],!(g=f.rows[0].cells[i])||"from"!=h&&"to"!=h&&"fromto"!=h||$(g).attr("rel",h).find("span,a").text(this.get_label("fromto"==h?d:h))}this.env.subject_col=null,this.env.flagged_col=null,this.env.status_col=null,this.env.coltypes.folder&&(this.env.coltypes.folder.hidden=!(this.env.search_request||this.env.search_id)||"base"==this.env.search_scope),(i=$.inArray("subject",this.env.listcols))>=0&&(this.env.subject_col=i,e&&(e.subject_col=i)),(i=$.inArray("flag",this.env.listcols))>=0&&(this.env.flagged_col=i),(i=$.inArray("status",this.env.listcols))>=0&&(this.env.status_col=i),e&&(e.hide_column("folder",this.env.coltypes.folder&&this.env.coltypes.folder.hidden||$.inArray("folder",this.env.listcols)<0),e.init_header())},this.set_rowcount=function(a,b){if(b&&b!=this.env.mailbox)return!1;$(this.gui_objects.countdisplay).html(a),this.set_page_buttons()},this.set_mailboxname=function(a){this.gui_objects.mailboxname&&a&&(this.gui_objects.mailboxname.innerHTML=a)},this.set_quota=function(a){this.gui_objects.quotadisplay&&a&&"text"==a.type&&$(this.gui_objects.quotadisplay).text((a.percent||0)+"%").attr("title",a.title),this.triggerEvent("setquota",a),this.env.quota_content=a},this.set_trash_count=function(a){this[(a?"un":"")+"mark_folder"](this.env.trash_mailbox,"empty","",!0)},this.set_unread_count=function(a,b,c,d){if(!this.gui_objects.mailboxlist)return!1;this.env.unread_counts[a]=b,this.set_unread_count_display(a,c),d?this.mark_folder(a,d,"",!0):b||this.unmark_folder(a,"recent","",!0)},this.set_unread_count_display=function(a,b){var c,d,e,f,g,h,i;if(f=this.get_folder_li(a,"",!0)){if(g=this.env.unread_counts[a]?this.env.unread_counts[a]:0,d=$(f).children("a").eq(0),e=d.children("span.unreadcount"),!e.length&&g&&(e=$("<span>").addClass("unreadcount").appendTo(d)),c=/\s+\([0-9]+\)$/i,h=0,(i=f.getElementsByTagName("div")[0])&&i.className.match(/collapsed/))for(var j in this.env.unread_counts)j.startsWith(a+this.env.delimiter)&&(h+=this.env.unread_counts[j]);g&&e.length?e.html(this.env.unreadwrap.replace(/%[sd]/,g)):e.length&&e.remove(),c=new RegExp(RegExp.escape(this.env.delimiter)+"[^"+RegExp.escape(this.env.delimiter)+"]+$"),a.match(c)&&this.set_unread_count_display(a.replace(c,""),!1),g+h>0?$(f).addClass("unread"):$(f).removeClass("unread")}if(c=/^\([0-9]+\)\s+/i,b&&document.title){var k="",l=String(document.title);k=g&&l.match(c)?l.replace(c,"("+g+") "):g?"("+g+") "+l:l.replace(c,""),this.set_pagetitle(k)}},this.set_headers=function(a){this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&a&&$(this.gui_objects.all_headers_box).html(a).show()},this.show_headers=function(a,b){this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&this.env.uid&&($(b).removeClass("show-headers").addClass("hide-headers"),$(this.gui_objects.all_headers_row).show(),b.onclick=function(){ref.command("hide-headers","",b)},this.gui_objects.all_headers_box.innerHTML||this.http_post("headers",{_uid:this.env.uid,_mbox:this.env.mailbox},this.display_message(this.get_label("loading"),"loading")))},this.hide_headers=function(a,b){this.gui_objects.all_headers_row&&this.gui_objects.all_headers_box&&($(b).removeClass("hide-headers").addClass("show-headers"),$(this.gui_objects.all_headers_row).hide(),b.onclick=function(){ref.command("show-headers","",b)})},this.folder_selector=function(a,b){var c=this.folder_selector_element;if(!c){var d=[],e=this.env.delimiter,f=$('<ul class="toolbarmenu">'),g=document.createElement("a");c=$('<div id="folder-selector" class="popupmenu"></div>'),g.href="#",g.className="icon",$.each(this.env.mailboxes_list,function(){var a=0,b=0,c=ref.env.mailboxes[this],f=c.id,h=$(g.cloneNode(!1)),i=$("<li>");for(c.virtual?h.addClass("virtual").attr("aria-disabled","true").attr("tabindex","-1"):h.addClass("active").data("id",c.id),c.class&&h.addClass(c.class);(b=f.indexOf(e,b))>=0;)a++,b++;h.css("padding-left",a?16*a+"px":0),h.append($("<span>").text(c.name)),i.append(h),d.push(i)}),f.append(d).appendTo(c),c.css({left:"-1000px",top:"-1000px"}).appendTo($("body")).show(),d.length>10&&c.css("max-height",10*$("li",c)[0].offsetHeight+9),c.on("click","a.active",function(a){return c.data("callback")($(this).data("id")),!1}),this.folder_selector_element=c}c.data("callback",b),this.show_menu("folder-selector",!0,a)},this.show_menu=function(a,b,c){var d="object"==typeof a?a.menu:a,e=$("#"+d),f=c&&c.target?$(c.target):$(e.attr("rel")||"#"+d+"link"),g=rcube_event.is_keyboard(c),h=e.attr("data-align")||"",i=!1;if("A"!=f.get(0).tagName&&f.closest("a").length&&(f=f.closest("a")),"string"==typeof a&&(a={menu:d}),e.length||(e=this.triggerEvent("menu-get",{name:d,props:a,originalEvent:c})),!e||!e.length)return this.triggerEvent(!1===b?"menu-close":"menu-open",{name:d,props:a,originalEvent:c});if(e.appendTo(document.body),void 0===b&&(b=!e.is(":visible")),b&&f.length){var j=$(window),k=f.offset(),l=h.indexOf("bottom")>=0;i="menuitem"==f.attr("role")||f.closest("[role=menuitem]").length>0,f.offsetWidth=f.outerWidth(),f.offsetHeight=f.outerHeight(),!l&&k.top+f.offsetHeight+e.height()>j.height()&&(l=!0),h.indexOf("right")>=0?k.left=k.left+f.outerWidth()-e.width():i&&(k.left=k.left+f.offsetWidth-5,k.top-=f.offsetHeight),k.left+e.width()>j.width()&&(k.left=j.width()-e.width()-12),k.top=Math.max(0,k.top+(l?-e.height():f.offsetHeight)),e.css({left:k.left+"px",top:k.top+"px"})}if(b){for(var m=this.menu_stack.length-1;i&&m>=0;m--)$(f).parents("#"+this.menu_stack[m]).length||"menuitem"==$(c.target).parent().attr("role")||this.hide_menu(this.menu_stack[m],c);i&&this.menu_stack.length?(e.data("parent",$.last(this.menu_stack)),e.css("z-index",($("#"+$.last(this.menu_stack)).css("z-index")||0)+1)):!i&&this.menu_stack.length&&this.hide_menu(this.menu_stack[0],c),e.show().attr("aria-hidden","false").data("opener",f.attr("aria-expanded","true").get(0)),this.triggerEvent("menu-open",{name:d,obj:e,props:a,originalEvent:c}),this.menu_stack.push(d),this.menu_keyboard_active=b&&g,this.menu_keyboard_active&&(this.focused_menu=d,e.find("a,input:not(:disabled)").not("[aria-disabled=true]").first().focus())}else this.hide_menu(d,c);return b},this.hide_menu=function(a,b){if(!this.menu_stack.length)return void this.triggerEvent("menu-close",{name:a,props:{menu:a},originalEvent:b});for(var c,d=rcube_event.is_keyboard(b),e=this.menu_stack.length-1;e>=0;e--)c=$("#"+this.menu_stack[e]).hide().attr("aria-hidden","true").data("parent",!1),this.triggerEvent("menu-close",{name:this.menu_stack[e],obj:c,props:{menu:this.menu_stack[e]},originalEvent:b}),this.menu_stack[e]==a&&(e=-1,c.data("opener")&&($(c.data("opener")).attr("aria-expanded","false"),d&&c.data("opener").focus())),this.menu_stack.pop();this.menu_stack.length&&d?(this.menu_keyboard_active=!0,this.focused_menu=$.last(this.menu_stack),c&&c.data("opener")||$("#"+this.focused_menu).find("a,input:not(:disabled)").not("[aria-disabled=true]").first().focus()):(this.focused_menu=null,this.menu_keyboard_active=!1)},this.element_position=function(a,b){var b=$(b),c=$(window),d=b.outerWidth(),e=b.outerHeight(),f=b.data("menu-pos"),g=c.height(),h=$(a).height(),i=$(a).width(),j=b.offset(),k=j.top,l=j.left+d;"bottom"==f?(k+=e,l-=d):l-=5,k+h>g&&(k-=h-e)<0&&(k=Math.max(0,(g-h)/2)),l+i>c.width()&&(l-=i+d),a.css({left:l+"px",top:k+"px"})},this.editor_init=function(a,b){this.editor=new rcube_text_editor(a,b)},this.html2plain=function(a,b){return this.format_converter(a,"html",b)},this.plain2html=function(a,b){return this.format_converter(a,"plain",b)},this.format_converter=function(a,b,c){if(!a||"html"==b&&!a.replace(/<[^>]+>|&nbsp;|\xC2\xA0|\s/g,"").length||"html"!=b&&!a.replace(/\xC2\xA0|\s/g,"").length)return c&&setTimeout(function(){c("")},50),!0;var d=this.env.editor_warned||confirm(this.get_label("editorwarning"));if(this.env.editor_warned=!0,!d)return!1;var e="?_task=utils&_action="+("html"==b?"html2text":"text2html"),f=this.set_busy(!0,"converting");return $.ajax({type:"POST",url:e,data:a,contentType:"application/octet-stream",error:function(a,b,c){ref.http_error(a,b,c,f)},success:function(a){ref.set_busy(!1,null,f),c&&c(a)}}),!0},this.url=function(a,b){var c="string"==typeof b?b:"";"string"!=typeof a?b=a:b&&"object"==typeof b||(b={}),a?b._action=a:this.env.action&&(b._action=this.env.action);var e,d=this.env.comm_path,f={};a&&a.match(/([a-z0-9_-]+)\/([a-z0-9-_.]+)/)&&(b._action=RegExp.$2,d=d.replace(/\_task=[a-z0-9_-]+/,"_task="+RegExp.$1));for(e in b)void 0!==b[e]&&null!==b[e]&&(f[e]=b[e]);return(f=$.param(f))&&(d+=(d.indexOf("?")>-1?"&":"?")+f),c&&(d+=(d.indexOf("?")>-1?"&":"?")+c),d},this.redirect=function(a,b){(b||null===b)&&this.set_busy(!0),this.is_framed()?parent.rcmail.redirect(a,b):(this.env.extwin&&("string"==typeof a?a+=(a.indexOf("?")<0?"?":"&")+"_extwin=1":a._extwin=1),this.location_href(a,window))},this.goto_url=function(a,b,c,d){var e=this.url(a,b);d&&(e=this.secure_url(e)),this.redirect(e,c)},this.location_href=function(a,b,c){c&&this.lock_frame(),"object"==typeof a&&(a=this.env.comm_path+"&"+$.param(a)),bw.ie&&b==window?$("<a>").attr("href",a).appendTo(document.body).get(0).click():b.location.href=a,this.start_keepalive()},this.update_state=function(a){if(window.history.replaceState)try{window.history.replaceState({},document.title,rcmail.url("",a))}catch(a){}},this.http_request=function(a,b,c,d){"POST"!=d&&(d="GET"),"object"!=typeof b&&(b=rcube_parse_query(b)),b._remote=1,b._unlock=c||0;var e=this.triggerEvent("request"+a,b);if(!1===e)return b._unlock&&this.set_busy(!1,null,b._unlock),!1;void 0!==e&&(b=e,b._action&&(a=b._action,delete b._action));var f=this.url(a);return this.start_keepalive(),$.ajax({type:d,url:f,data:b,dataType:"json",success:function(a){ref.http_response(a)},error:function(b,d,e){ref.http_error(b,d,e,c,a)}})},this.http_get=this.http_request,this.http_post=function(a,b,c){return this.http_request(a,b,c,"POST")},this.abort_request=function(a){a.request&&a.request.abort(),a.lock&&this.set_busy(!1,null,a.lock)},this.http_response=function(response){if(response){response.unlock&&this.set_busy(!1),this.triggerEvent("responsebefore",{response:response}),this.triggerEvent("responsebefore"+response.action,{response:response}),response.env&&this.set_env(response.env);var i;if("object"==typeof response.texts)for(i in response.texts)"string"==typeof response.texts[i]&&this.add_label(i,response.texts[i]);if(response.exec&&eval(response.exec),response.callbacks&&response.callbacks.length)for(i=0;i<response.callbacks.length;i++)this.triggerEvent(response.callbacks[i][0],response.callbacks[i][1]);switch(response.action){case"delete":if("addressbook"==this.task){var sid,uid=this.contact_list.get_selection(),writable=!1;uid&&this.contact_list.rows[uid]&&(""==this.env.source?(sid=String(uid).replace(/^[^-]+-/,""),writable=sid&&this.env.address_sources[sid]&&!this.env.address_sources[sid].readonly):writable=!this.env.address_sources[this.env.source].readonly),this.enable_command("compose",uid&&this.contact_list.rows[uid]),this.enable_command("delete","edit",writable),this.enable_command("export",this.contact_list&&this.contact_list.rowcount>0),this.enable_command("export-selected","print",!1)}case"move":"show"==this.env.action?(this.enable_command(this.env.message_commands,!0),this.env.list_post||this.enable_command("reply-list",!1)):"addressbook"==this.task&&this.triggerEvent("listupdate",{folder:this.env.source,rowcount:this.contact_list.rowcount});case"purge":case"expunge":"mail"==this.task&&(this.env.exists||(this.env.contentframe&&this.show_contentframe(!1),this.enable_command(this.env.message_commands,"purge","expunge","select-all","select-none","expand-all","expand-unread","collapse-all",!1)),this.message_list&&this.triggerEvent("listupdate",{folder:this.env.mailbox,rowcount:this.message_list.rowcount}));break;case"refresh":case"check-recent":$.each(this.env.recent_flags||{},function(a,b){ref.set_message(a,"deleted",b.deleted),ref.set_message(a,"replied",b.answered),ref.set_message(a,"unread",!b.seen),ref.set_message(a,"forwarded",b.forwarded),ref.set_message(a,"flagged",b.flagged)}),delete this.env.recent_flags;case"getunread":case"search":this.env.qsearch=null;case"list":if("mail"==this.task){var is_multifolder=this.is_multifolder_listing(),list=this.message_list,uid=this.env.list_uid;this.enable_command("show","select-all","select-none",this.env.messagecount>0),this.enable_command("expunge",this.env.exists&&!is_multifolder),this.enable_command("purge",this.purge_mailbox_test()&&!is_multifolder),this.enable_command("import-messages",!is_multifolder),this.enable_command("expand-all","expand-unread","collapse-all",this.env.threading&&this.env.messagecount&&!is_multifolder),list&&("list"!=response.action&&"search"!=response.action||(uid&&(list.rows[uid]||(uid+="-"+this.env.mailbox),list.rows[uid]&&list.select(uid),delete this.env.list_uid),this.enable_command("set-listmode",this.env.threads&&!is_multifolder),list.rowcount>0&&!$(document.activeElement).is("input,textarea")&&list.focus(),list.triggerEvent("select")),"getunread"!=response.action&&this.triggerEvent("listupdate",{folder:this.env.mailbox,rowcount:list.rowcount}))}else"addressbook"==this.task&&(this.enable_command("export",this.contact_list&&this.contact_list.rowcount>0),"list"!=response.action&&"search"!=response.action||(this.enable_command("search-create",""==this.env.source),this.enable_command("search-delete",this.env.search_id),this.update_group_commands(),this.contact_list.rowcount>0&&!$(document.activeElement).is("input,textarea")&&this.contact_list.focus(),this.triggerEvent("listupdate",{folder:this.env.source,rowcount:this.contact_list.rowcount})));break;case"list-contacts":case"search-contacts":this.contact_list&&this.contact_list.rowcount>0&&this.contact_list.focus()}response.unlock&&this.hide_message(response.unlock),this.triggerEvent("responseafter",{response:response}),this.triggerEvent("responseafter"+response.action,{response:response}),this.start_keepalive()}},this.http_error=function(a,b,c,d,e){var f=a.statusText;if(this.set_busy(!1,null,d),a.abort(),!this.unload){a.status&&f?this.display_message(this.get_label("servererror")+" ("+f+")","error"):"timeout"==b?this.display_message(this.get_label("requesttimedout"),"error"):0==a.status&&"abort"!=b&&this.display_message(this.get_label("connerror"),"error");var g=a.getResponseHeader("Location");if(g&&"compose"!=this.env.action&&this.redirect(g),403==a.status)return void(this.is_framed()?parent:window).location.reload();"keep-alive"==e&&setTimeout(function(){ref.keep_alive(),ref.start_keepalive()},3e4)}},this.session_error=function(a){this.env.server_error=401,"compose"==this.env.action?(this.save_compose_form_local(),this.compose_skip_unsavedcheck=!0):a&&setTimeout(function(){ref.redirect(a,!0)},2e3)},this.iframe_loaded=function(a){this.set_busy(!1,null,a),this.submit_timer&&clearTimeout(this.submit_timer)},this.multi_thread_http_request=function(a){var b,c,d=(new Date).getTime(),e=a.threads||1;for(a.reqid=d,a.running=0,a.requests=[],a.result=[],a._items=$.extend([],a.items),a.lock||(a.lock=this.display_message(this.get_label("loading"),"loading")),this.http_request_jobs[d]=a,b=0;b<e&&void 0!==(c=a._items.shift());b++)a.running++,a.requests.push(this.multi_thread_send_request(a,c));return d},this.multi_thread_send_request=function(a,b){var c,d,e;if(a.postdata){d={};for(c in a.postdata)d[c]=String(a.postdata[c]).replace("%s",b);d._reqid=a.reqid}else if("string"==typeof a.query)e=a.query.replace("%s",b),e+="&_reqid="+a.reqid;else if("object"==typeof a.query&&a.query){e={};for(c in a.query)e[c]=String(a.query[c]).replace("%s",b);e._reqid=a.reqid}return d?this.http_post(a.action,d):this.http_request(a.action,e)},this.multi_thread_http_response=function(a,b){var c=this.http_request_jobs[b];if(!(!c||c.running<=0||c.cancelled)){c.running--,c.onresponse&&"function"==typeof c.onresponse&&c.onresponse(a),c.result=$.extend(c.result,a);var d=c._items.shift();void 0!==d?(c.running++,c.requests.push(this.multi_thread_send_request(c,d))):0==c.running&&(c.whendone&&"function"==typeof c.whendone&&c.whendone(c.result),this.set_busy(!1,"",c.lock),delete this.http_request_jobs[b])}},this.multi_thread_request_abort=function(a){var b=this.http_request_jobs[a];if(b){for(var c=0;b.running>0&&c<b.requests.length;c++)b.requests[c].abort&&b.requests[c].abort();b.running=0,b.cancelled=!0,this.set_busy(!1,"",b.lock)}},this.async_upload_form=function(a,b,c){var d=(new Date).getTime(),e="rcmupload"+d,f=this.async_upload_form_frame(e);if(this.env.upload_progress_name){var g=this.env.upload_progress_name,h=$("input[name="+g+"]",a);h.length||(h=$("<input>").attr({type:"hidden",name:g}),h.prependTo(a)),h.val(d)}return f.on("load",{ts:d},c),$(a).attr({target:e,action:this.url(b,{_id:this.env.compose_id||"",_uploadid:d,_from:this.env.action}),method:"POST"}).attr(a.encoding?"encoding":"enctype","multipart/form-data").submit(),e},this.async_upload_form_frame=function(a){return $("<iframe>").attr({name:a,style:"border: none; width: 0; height: 0; visibility: hidden"}).appendTo(document.body)},this.document_drag_hover=function(a,b){$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("active")},this.file_drag_hover=function(a,b){a.preventDefault(),a.stopPropagation(),$(this.gui_objects.filedrop)[b?"addClass":"removeClass"]("hover")},this.file_dropped=function(a){this.file_drag_hover(a,!1);var b,c=a.target.files||a.dataTransfer.files,d=window.FormData?new FormData:null,e=(this.env.filedrop.fieldname||"_file")+(this.env.filedrop.single?"":"[]"),f="------multipartformboundary"+(new Date).getTime(),g="--",h="\r\n",i=g+f+h,j={_id:this.env.compose_id||this.env.cid||"",_remote:1,_from:this.env.action};if(c&&c.length){for(var q,m=function(){var a=c.length>1,b=(new Date).getTime(),e=$("<span>").text(a?ref.get_label("uploadingmany"):c[0].name).html();ref.add2attachment_list(b,{name:"",html:e,classname:"uploading",complete:!1})||(ref.file_upload_id=ref.set_busy(!0,"uploading")),i+=g+f+g+h,j._uploadid=b,$.ajax({type:"POST",dataType:"json",url:ref.url(ref.env.filedrop.action||"upload",j),contentType:!d&&"multipart/form-data; boundary="+f,processData:!1,timeout:0,data:d||i,headers:{"X-Roundcube-Request":ref.env.request_token},xhr:function(){var a=jQuery.ajaxSettings.xhr();return!d&&a.sendAsBinary&&(a.send=a.sendAsBinary),a},success:function(a){ref.http_response(a)},error:function(a,b,c){ref.http_error(a,b,c,null,"attachment")}})},n=this.env.filedrop.single?0:c.length-1,o=0,p=0;o<=n&&(q=c[p]);p++)if(q.name||(q.name=q.fileName),q.size||(q.size=q.fileSize),q.type||(q.type="application/octet-stream"),!d&&/[^\x20-\x7E]/.test(q.name)&&(q.name_bin=unescape(encodeURIComponent(q.name))),!this.env.filedrop.filter||q.type.match(new RegExp(this.env.filedrop.filter))){if(d){if(d.append(e,q),o==n)return m()}else if(window.FileReader){var r=new FileReader;r.onload=function(a,b){return function(c){if(i+='Content-Disposition: form-data; name="'+e+'"',i+='; filename="'+(q.name_bin||a.name)+'"'+h,i+="Content-Length: "+a.size+h,i+="Content-Type: "+a.type+h+h,i+=r.result+h,i+=g+f+h,b==n)return m()}}(q,o),r.readAsBinaryString(q)}else if(q.getAsBinary&&(i+='Content-Disposition: form-data; name="'+e+'"',i+='; filename="'+(q.name_bin||q.name)+'"'+h,i+="Content-Length: "+q.size+h,i+="Content-Type: "+q.type+h+h,i+=q.getAsBinary()+h,i+=g+f+h,o==n))return m();o++}}else if(b=a.dataTransfer.getData("roundcube-uri")){var k=(new Date).getTime(),l=$("<span>").text(a.dataTransfer.getData("roundcube-name")||this.get_label("attaching")).html();j._uri=b,j._uploadid=k,this.add2attachment_list(k,{name:"",html:l,classname:"uploading",complete:!1})||(this.file_upload_id=this.set_busy(!0,"attaching")),this.http_post(this.env.filedrop.action||"upload",j)}},this.start_keepalive=function(){if(this.env.session_lifetime&&!this.env.framed&&!this.env.extwin&&"login"!=this.task&&"print"!=this.env.action){this._keepalive&&clearInterval(this._keepalive);var a=.5*Math.min(1800,this.env.session_lifetime)*1e3;this._keepalive=setInterval(function(){ref.keep_alive()},a<3e4?3e4:a)}},this.start_refresh=function(){!this.env.refresh_interval||this.env.framed||this.env.extwin||"login"==this.task||"print"==this.env.action||(this._refresh&&clearInterval(this._refresh),this._refresh=setInterval(function(){ref.refresh()},1e3*this.env.refresh_interval))},this.keep_alive=function(){this.busy||this.http_request("keep-alive")},this.refresh=function(){if(this.busy)return void setTimeout(function(){ref.refresh(),ref.start_refresh()},1e4);var a={},b=this.set_busy(!0,"refreshing");"mail"==this.task&&this.gui_objects.mailboxlist&&(a=this.check_recent_params()),a._last=Math.floor(this.env.lastrefresh.getTime()/1e3),this.env.lastrefresh=new Date,this.http_post("refresh",a,b)},this.check_recent_params=function(){var a={_mbox:this.env.mailbox};return this.gui_objects.mailboxlist&&(a._folderlist=1),this.gui_objects.quotadisplay&&(a._quota=1),this.env.search_request&&(a._search=this.env.search_request),this.gui_objects.messagelist&&(a._list=1,a._uids=$.map(this.message_list.rows,function(a,b){return b}).join(",")),a},this.quote_html=function(a){return String(a).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},this.opener=function(a,b){var c,d=window.opener;try{if(d&&!d.closed){if(a&&(!d.rcmail||d.rcmail.env.framed)&&d.parent&&d.parent.rcmail&&(d=d.parent),d.rcmail&&b)for(c in b)if(d.rcmail.env[c]!=b[c])return;return d.rcmail}}catch(a){}},this.get_single_uid=function(){var a=this.env.uid||(this.message_list?this.message_list.get_single_selection():null);return ref.triggerEvent("get_single_uid",{uid:a})||a},this.get_single_cid=function(){var a=this.env.cid||(this.contact_list?this.contact_list.get_single_selection():null);return ref.triggerEvent("get_single_cid",{cid:a})||a},this.get_message_mailbox=function(a){return((this.env.messages&&a?this.env.messages[a]:null)||{}).mbox||this.env.mailbox},this.params_from_uid=function(a,b){return b||(b={}),b._uid=String(a).split("-")[0],b._mbox=this.get_message_mailbox(a),b},this.get_caret_pos=function(a){return void 0!==a.selectionEnd?a.selectionEnd:a.value.length},this.set_caret_pos=function(a,b){try{a.setSelectionRange&&a.setSelectionRange(b,b)}catch(a){}},this.get_input_selection=function(a){var b=0,c=0,d="";return"number"==typeof a.selectionStart&&"number"==typeof a.selectionEnd&&(d=a.value,b=a.selectionStart,c=a.selectionEnd),{start:b,end:c,text:d.substr(b,c-b)}},this.lock_form=function(a,b){if(a&&a.elements){var c,d,e;for(b&&(this.disabled_form_elements=[]),c=0,d=a.elements.length;c<d;c++)e=a.elements[c],"hidden"!=e.type&&(b&&e.disabled?this.disabled_form_elements.push(e):(b||$.inArray(e,this.disabled_form_elements)<0)&&(e.disabled=b))}},this.mailto_handler_uri=function(){return location.href.split("?")[0]+"?_task=mail&_action=compose&_to=%s"},this.register_protocol_handler=function(a){try{window.navigator.registerProtocolHandler("mailto",this.mailto_handler_uri(),a)}catch(a){this.display_message(String(a),"error")}},this.check_protocol_handler=function(a,b){var c=window.navigator;if(c&&"function"==typeof c.registerProtocolHandler)if("function"==typeof c.isProtocolHandlerRegistered){var d=c.isProtocolHandlerRegistered("mailto",this.mailto_handler_uri());d&&$(b).parent().find(".mailtoprotohandler-status").html(d)}else $(b).click(function(){return ref.register_protocol_handler(a),!1});else $(b).addClass("disabled").click(function(){return!1})},this.browser_capabilities_check=function(){this.env.browser_capabilities||(this.env.browser_capabilities={}),$.each(["pdf","flash","tif"],function(){void 0===ref.env.browser_capabilities[this]&&(ref.env.browser_capabilities[this]=ref[this+"_support_check"]())})},this.browser_capabilities=function(){if(!this.env.browser_capabilities)return"";var a,b=[];for(a in this.env.browser_capabilities)b.push(a+"="+this.env.browser_capabilities[a]);return b.join()},this.tif_support_check=function(){return window.setTimeout(function(){var a=new Image;a.onload=function(){ref.env.browser_capabilities.tif=1},a.onerror=function(){ref.env.browser_capabilities.tif=0},a.src=ref.assets_path("program/resources/blank.tif")},10),0},this.pdf_support_check=function(){var a=navigator.mimeTypes?navigator.mimeTypes["application/pdf"]:{},b=navigator.plugins,c=b.length,d=/Adobe Reader|PDF|Acrobat/i;if(a&&a.enabledPlugin)return 1;if("ActiveXObject"in window){try{if(a=new ActiveXObject("AcroPDF.PDF"))return 1}catch(a){}try{if(a=new ActiveXObject("PDF.PdfCtrl"))return 1}catch(a){}}for(i=0;i<c;i++)if("String"==typeof(a=b[i])){if(d.test(a))return 1}else if(a.name&&d.test(a.name))return 1;return window.setTimeout(function(){$("<object>").css({position:"absolute",left:"-10000px"}).attr({data:ref.assets_path("program/resources/dummy.pdf"),width:1,height:1,type:"application/pdf"}).load(function(){ref.env.browser_capabilities.pdf=1}).error(function(){ref.env.browser_capabilities.pdf=0}).appendTo($("body"))},10),0},this.flash_support_check=function(){var a=navigator.mimeTypes?navigator.mimeTypes["application/x-shockwave-flash"]:{};if(a&&a.enabledPlugin)return 1;if("ActiveXObject"in window)try{if(a=new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))return 1}catch(a){}return 0},this.assets_path=function(a){return this.env.assets_path&&!a.startsWith(this.env.assets_path)&&(a=this.env.assets_path+a),a},this.set_cookie=function(a,b,c){setCookie(a,b,c,this.env.cookie_path,this.env.cookie_domain,this.env.cookie_secure)},this.get_local_storage_prefix=function(){return this.local_storage_prefix||(this.local_storage_prefix="roundcube."+(this.env.user_id||"anonymous")+"."),this.local_storage_prefix},this.local_storage_get_item=function(a,b,c){var d,e;try{d=localStorage.getItem(this.get_local_storage_prefix()+a),e=JSON.parse(d)}catch(a){}return e||b||null},this.local_storage_set_item=function(a,b,c){try{return localStorage.setItem(this.get_local_storage_prefix()+a,JSON.stringify(b)),!0}catch(a){return!1}},this.local_storage_remove_item=function(a){try{return localStorage.removeItem(this.get_local_storage_prefix()+a),!0}catch(a){return!1}},this.print_dialog=function(){bw.safari?setTimeout("window.print()",10):window.print()}}rcube_webmail.long_subject_title=function(a,b){if(!a.title){var c=$(a);c.width()+15*(b||0)>c.parent().width()&&(a.title=rcube_webmail.subject_text(a))}},rcube_webmail.long_subject_title_ex=function(a){if(!a.title){var b=$(a),c=$.trim(b.text()),d=$("<span>").text(c).css({position:"absolute",float:"left",visibility:"hidden","font-size":b.css("font-size"),"font-weight":b.css("font-weight")}).appendTo($("body")),e=d.width();d.remove(),e+15*$("span.branch",b).width()>b.width()&&(a.title=rcube_webmail.subject_text(a))}},rcube_webmail.subject_text=function(a){var b=$(a).clone();return b.find(".skip-on-drag").remove(),b.text()},rcube_webmail.set_iframe_events=function(a){$("iframe").each(function(){var b=$(this);$.each(a,function(a,c){b.on("load",function(b){try{$(this).contents().on(a,c)}catch(b){}});try{b.contents().on(a,c)}catch(a){}})})},rcube_webmail.prototype.get_cookie=getCookie,rcube_webmail.prototype.addEventListener=rcube_event_engine.prototype.addEventListener,rcube_webmail.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener,rcube_webmail.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;